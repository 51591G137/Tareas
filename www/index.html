<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gestor Elite</title>
    <style>
        :root { --primary: #4a90e2; --bg: #f0f2f5; --card: #ffffff; --danger: #ff4d4d; --success: #2ecc71; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 70px; }
        .screen { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .card { background: var(--card); padding: 15px; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        button { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; }
        button.secondary { background: #e0e0e0; color: #333; margin-top: 5px; }
        button.danger { background: var(--danger); }
        
        /* Usuarios */
        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; margin-bottom: 10px; border-radius: 12px; border: 1px solid #eee; }
        
        /* Configuraci√≥n (Rueda dentada) */
        .settings-btn { font-size: 40px; background: none; border: none; color: #888; cursor: pointer; display: block; margin: 20px auto; width: auto; }

        /* Tareas */
        .task-card { border-left: 5px solid #ccc; }
        .st-espera { border-left-color: #f1c40f; }
        .st-proceso { border-left-color: #3498db; }
        .st-terminada { border-left-color: var(--success); }
        .st-perdida { border-left-color: var(--danger); opacity: 0.7; }

        .days-selector { display: flex; justify-content: space-between; margin: 10px 0; }
        .day-check { display: flex; flex-direction: column; align-items: center; font-size: 10px; }

        .user-checkbox-list { max-height: 100px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; }

        /* Nav */
        .nav-bottom { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #ddd; height: 60px; }
        .nav-btn { flex: 1; border: none; background: none; font-size: 12px; color: #999; }
        .nav-btn.active { color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>

    <div id="screen-home" class="screen active">
        <h2 style="text-align: center; margin-top: 40px;">Hola, ¬øqui√©n eres?</h2>
        <p style="text-align: center; color: #666;">Selecciona tu perfil o crea uno nuevo</p>
        <div id="users-list-home"></div>
        
        <button class="settings-btn" onclick="navTo('screen-settings')">‚öôÔ∏è</button>
    </div>

    <div id="screen-settings" class="screen">
        <button class="secondary" onclick="navTo('screen-home')" style="width: auto;">‚¨Ö Volver</button>
        <h3>Configuraci√≥n</h3>
        
        <div class="card">
            <h4>Gestionar Usuarios</h4>
            <input type="text" id="new-user-name" placeholder="Nombre nuevo usuario">
            <button onclick="createUser()">A√±adir Usuario</button>
            <div id="users-manage-list" style="margin-top:15px;"></div>
        </div>

        <div class="card">
            <h4>Crear Tarea Global</h4>
            <input type="text" id="gt-title" placeholder="T√≠tulo de la tarea">
            <input type="date" id="gt-date">
            
            <p>Asignar a:</p>
            <div id="gt-user-assign" class="user-checkbox-list"></div>

            <div style="margin: 10px 0;">
                <label><input type="checkbox" id="gt-repeat" onchange="toggleRepeat()"> ¬øSe repite?</label>
            </div>

            <div id="repeat-options" style="display:none;">
                <div class="days-selector">
                    <label class="day-check">Lu<input type="checkbox" class="day-opt" value="1"></label>
                    <label class="day-check">Ma<input type="checkbox" class="day-opt" value="2"></label>
                    <label class="day-check">Mi<input type="checkbox" class="day-opt" value="3"></label>
                    <label class="day-check">Ju<input type="checkbox" class="day-opt" value="4"></label>
                    <label class="day-check">Vi<input type="checkbox" class="day-opt" value="5"></label>
                    <label class="day-check">Sa<input type="checkbox" class="day-opt" value="6"></label>
                    <label class="day-check">Do<input type="checkbox" class="day-opt" value="0"></label>
                </div>
            </div>

            <h4>Puntuaciones</h4>
            <div id="gt-scores">
                <label>Responsabilidad <input type="number" class="sc-in" data-cat="Responsabilidad" value="0"></label>
                <label>Amabilidad <input type="number" class="sc-in" data-cat="Amabilidad" value="0"></label>
                <label>Respeto <input type="number" class="sc-in" data-cat="Respeto" value="0"></label>
            </div>
            <button onclick="saveGlobalTask()" style="margin-top:10px;">Crear Tareas</button>
        </div>
    </div>

    <div id="main-app" style="display:none;">
        <div id="view-tasks" class="screen">
            <h2 id="user-title">Tareas</h2>
            <div id="tasks-container"></div>
        </div>

        <div id="view-calendar" class="screen">
            <h2>Calendario</h2>
            <div id="calendar-container"></div>
        </div>

        <div id="view-scores" class="screen">
            <h2>Mi Puntuaci√≥n</h2>
            <div id="scores-container"></div>
        </div>

        <nav class="nav-bottom">
            <button class="nav-btn" onclick="showView('view-tasks')">Tareas</button>
            <button class="nav-btn" onclick="showView('view-calendar')">Calendario</button>
            <button class="nav-btn" onclick="showView('view-scores')">Puntos</button>
            <button class="nav-btn" onclick="logout()">Salir</button>
        </nav>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('eliteDB')) || { users: [], categories: ['Responsabilidad', 'Amabilidad', 'Respeto'] };
        let currentUser = null;
        const dayNames = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];

        function save() { localStorage.setItem('eliteDB', JSON.stringify(db)); }

        function navTo(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'screen-settings') renderSettings();
            if(id === 'screen-home') renderHome();
        }

        function renderHome() {
            const list = document.getElementById('users-list-home');
            list.innerHTML = '';
            db.users.forEach(u => {
                list.innerHTML += `<div class="user-item" onclick="login(${u.id})"><strong>${u.name}</strong></div>`;
            });
        }

        function renderSettings() {
            const list = document.getElementById('users-manage-list');
            list.innerHTML = '';
            db.users.forEach(u => {
                list.innerHTML += `
                    <div class="user-item">
                        <input type="text" value="${u.name}" onchange="updateUserName(${u.id}, this.value)">
                        <button class="danger" onclick="deleteUser(${u.id})" style="width:auto; padding:5px;">Eliminar</button>
                    </div>`;
            });

            const assignList = document.getElementById('gt-user-assign');
            assignList.innerHTML = '';
            db.users.forEach(u => {
                assignList.innerHTML += `<label style="display:block;"><input type="checkbox" class="assign-user" value="${u.id}"> ${u.name}</label>`;
            });
        }

        function createUser() {
            const name = document.getElementById('new-user-name').value;
            if(!name) return;
            db.users.push({ id: Date.now(), name, tasks: [] });
            save();
            document.getElementById('new-user-name').value = '';
            renderSettings();
        }

        function updateUserName(id, name) {
            const u = db.users.find(u => u.id === id);
            if(u) u.name = name;
            save();
        }

        function deleteUser(id) {
            if(confirm('¬øBorrar usuario?')) {
                db.users = db.users.filter(u => u.id !== id);
                save();
                renderSettings();
            }
        }

        function toggleRepeat() {
            document.getElementById('repeat-options').style.display = document.getElementById('gt-repeat').checked ? 'block' : 'none';
        }

        function login(id) {
            currentUser = db.users.find(u => u.id === id);
            document.getElementById('screen-home').classList.remove('active');
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('user-title').innerText = `Tareas de ${currentUser.name}`;
            showView('view-tasks');
        }

        function logout() {
            document.getElementById('main-app').style.display = 'none';
            navTo('screen-home');
        }

        function showView(viewId) {
            document.querySelectorAll('#main-app .screen').forEach(s => s.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            if(viewId === 'view-tasks') renderTasks();
            if(viewId === 'view-calendar') renderCalendar();
            if(viewId === 'view-scores') renderScores();
        }

        // L√ìGICA DE TAREAS Y REPETICI√ìN
        function saveGlobalTask() {
            const title = document.getElementById('gt-title').value;
            const startDate = document.getElementById('gt-date').value;
            const isRepeat = document.getElementById('gt-repeat').checked;
            const assignedUsers = Array.from(document.querySelectorAll('.assign-user:checked')).map(el => parseInt(el.value));
            
            if(!title || assignedUsers.length === 0) return alert("Falta t√≠tulo o usuarios");

            let scores = {};
            document.querySelectorAll('.sc-in').forEach(i => scores[i.dataset.cat] = parseInt(i.value) || 0);

            assignedUsers.forEach(uId => {
                const user = db.users.find(u => u.id === uId);
                const groupId = Date.now() + Math.random();

                if(!isRepeat) {
                    user.tasks.push({ id: Date.now() + Math.random(), title, date: startDate, status: 'En espera', scores, isRepeat: false });
                } else {
                    const selectedDays = Array.from(document.querySelectorAll('.day-opt:checked')).map(el => parseInt(el.value));
                    createRepeatedTasks(user, title, startDate, selectedDays, scores, groupId);
                }
            });

            save();
            alert("Tareas creadas");
            navTo('screen-home');
        }

        function createRepeatedTasks(user, title, startDateStr, days, scores, groupId) {
            let current = startDateStr ? new Date(startDateStr) : new Date();
            let count = 0;
            // Generar hoy y las pr√≥ximas ocurrencias hasta completar 3 eventos
            while(count < 4) { // 4 para asegurar hoy + 3 futuros
                if(days.includes(current.getDay())) {
                    const dateStr = current.toISOString().split('T')[0];
                    user.tasks.push({
                        id: Date.now() + Math.random(),
                        groupId: groupId,
                        title: `${title}. ${dayNames[current.getDay()]}`,
                        baseTitle: title,
                        date: dateStr,
                        status: 'En espera',
                        scores: scores,
                        isRepeat: true,
                        repeatDays: days
                    });
                    count++;
                }
                current.setDate(current.getDate() + 1);
            }
        }

        function renderTasks() {
            const container = document.getElementById('tasks-container');
            container.innerHTML = '';
            // Tareas no archivadas
            currentUser.tasks.filter(t => t.status === 'En espera' || t.status === 'En proceso').forEach(t => {
                container.innerHTML += `
                    <div class="card task-card st-${t.status.toLowerCase().replace(" ", "-")}" onclick="changeStatus(${t.id})">
                        <strong>${t.title}</strong><br>
                        <small>${t.date || 'Sin fecha'} | Estado: ${t.status}</small>
                        ${t.isRepeat ? '<br><small>üîÑ Repetitiva</small>' : ''}
                    </div>`;
            });
        }

        function changeStatus(taskId) {
            const t = currentUser.tasks.find(t => t.id === taskId);
            const next = { "En espera": "En proceso", "En proceso": "Terminada", "Terminada": "Perdida", "Perdida": "En espera" };
            t.status = next[t.status];
            
            if(t.status === 'Terminada' || t.status === 'Perdida') {
                // Al archivar, si es repetitiva y cambiamos el check de repetici√≥n
                // (En esta versi√≥n simplificada, al archivar una se mantiene la l√≥gica de las siguientes)
            }
            
            save();
            renderTasks();
        }

        function renderCalendar() {
            const container = document.getElementById('calendar-container');
            container.innerHTML = '';
            const dated = currentUser.tasks.filter(t => t.date).sort((a,b) => new Date(a.date) - new Date(b.date));
            dated.forEach(t => {
                container.innerHTML += `
                    <div class="card st-${t.status.toLowerCase().replace(" ", "-")}" style="border-left:4px solid">
                        <small>${t.date}</small><br>
                        <strong>${t.title}</strong> (${t.status})
                    </div>`;
            });
        }

        function renderScores() {
            const container = document.getElementById('scores-container');
            container.innerHTML = '';
            let totals = {};
            db.categories.forEach(c => totals[c] = 0);

            currentUser.tasks.forEach(t => {
                if(t.status === 'Terminada') {
                    for(let cat in t.scores) totals[cat] += t.scores[cat];
                }
            });

            for(let cat in totals) {
                container.innerHTML += `<div class="card"><strong>${cat}:</strong> ${totals[cat]} puntos</div>`;
            }
        }

        renderHome();
    </script>
</body>
</html>