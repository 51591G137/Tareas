<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gestor Elite</title>
    <style>
        :root { 
            --primary: #4a90e2; 
            --bg: #f0f2f5; 
            --card: #ffffff; 
            --danger: #ff4d4d; 
            --success: #2ecc71;
            --warning: #f39c12;
            --info: #3498db;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding-bottom: 70px; 
        }
        .screen { 
            display: none; 
            padding: 20px; 
            animation: fadeIn 0.3s; 
        }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .card { 
            background: var(--card); 
            padding: 15px; 
            margin-bottom: 15px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
        }
        button { 
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 8px; 
            font-weight: bold; 
            width: 100%; 
            cursor: pointer; 
            margin-top: 5px;
        }
        button.secondary { background: #95a5a6; color: #fff; }
        button.danger { background: var(--danger); }
        button.small { width: auto; padding: 8px 12px; font-size: 12px; }
        
        input, select { 
            width: 100%; 
            padding: 10px; 
            margin: 5px 0; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            box-sizing: border-box; 
        }
        
        /* Usuarios */
        .user-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px; 
            background: white; 
            margin-bottom: 10px; 
            border-radius: 12px; 
            border: 1px solid #eee;
            cursor: pointer;
            transition: all 0.2s;
        }
        .user-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        /* Configuraci√≥n (Rueda dentada) */
        .settings-btn { 
            font-size: 50px; 
            background: none; 
            border: none; 
            color: #888; 
            cursor: pointer; 
            display: block; 
            margin: 30px auto; 
            width: auto;
            transition: transform 0.3s;
        }
        .settings-btn:hover { transform: rotate(90deg); }

        /* Tareas */
        .task-card { 
            border-left: 5px solid #ccc; 
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .st-espera { border-left-color: var(--warning); }
        .st-proceso { border-left-color: var(--info); }
        .st-terminada { border-left-color: var(--success); }
        .st-perdida { border-left-color: var(--danger); opacity: 0.7; }

        .status-indicator {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .status-espera { background: var(--warning); color: #fff; }
        .status-proceso { background: var(--info); color: #fff; }
        .status-terminada { background: var(--success); color: #fff; }
        .status-perdida { background: var(--danger); color: #fff; }

        .days-selector { 
            display: flex; 
            justify-content: space-between; 
            margin: 10px 0; 
            flex-wrap: wrap;
            gap: 5px;
        }
        .day-check { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-size: 10px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex: 1;
            min-width: 40px;
        }

        .user-checkbox-list { 
            max-height: 150px; 
            overflow-y: auto; 
            border: 1px solid #ddd; 
            padding: 10px; 
            border-radius: 5px; 
            margin: 10px 0;
        }
        .user-checkbox-list label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 0;
        }
        .user-checkbox-list input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        /* Nav */
        .nav-bottom { 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            background: #fff; 
            display: flex; 
            border-top: 1px solid #ddd; 
            height: 60px; 
            z-index: 100;
        }
        .nav-btn { 
            flex: 1; 
            border: none; 
            background: none; 
            font-size: 12px; 
            color: #999; 
            cursor: pointer;
        }
        .nav-btn.active { color: var(--primary); font-weight: bold; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .modal-buttons button {
            flex: 1;
        }

        .task-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .task-actions button {
            flex: 1;
            min-width: 80px;
            font-size: 11px;
            padding: 8px;
        }

        .admin-task-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }

        .edit-task-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 10px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .edit-task-btn:hover {
            background: #3a7bc8;
        }
    </style>
</head>
<body>

    <!-- Pantalla de inicio -->
    <div id="screen-home" class="screen active">
        <h2 style="text-align: center; margin-top: 40px;">Hola, ¬øqui√©n eres?</h2>
        <p style="text-align: center; color: #666;">Selecciona tu perfil</p>
        <div id="users-list-home"></div>
        
        <button class="settings-btn" onclick="navTo('screen-settings')">‚öôÔ∏è</button>
    </div>

    <!-- Pantalla de configuraci√≥n -->
    <div id="screen-settings" class="screen">
        <button class="secondary small" onclick="navTo('screen-home')" style="margin-bottom: 15px;">‚¨Ö Volver</button>
        <h3>Configuraci√≥n</h3>
        
        <!-- Gestionar Usuarios -->
        <div class="card">
            <h4>Gestionar Usuarios</h4>
            <input type="text" id="new-user-name" placeholder="Nombre nuevo usuario">
            <button onclick="createUser()">A√±adir Usuario</button>
            <div id="users-manage-list" style="margin-top:15px;"></div>
        </div>

        <!-- Crear Tarea Global -->
        <div class="card">
            <h4>Crear Tarea Global</h4>
            <input type="text" id="gt-title" placeholder="T√≠tulo de la tarea">
            <label style="font-size: 12px; color: #666; margin-top: 5px;">Fecha (opcional):</label>
            <input type="date" id="gt-date">
            
            <p style="margin: 10px 0 5px 0;"><strong>Asignar a:</strong></p>
            <div id="gt-user-assign" class="user-checkbox-list"></div>

            <div style="margin: 10px 0;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="gt-repeat" onchange="toggleRepeat()" style="width: auto; margin: 0;"> 
                    ¬øSe repite?
                </label>
            </div>

            <div id="repeat-options" style="display:none;">
                <p style="margin: 5px 0;"><strong>D√≠as de repetici√≥n:</strong></p>
                <div class="days-selector">
                    <label class="day-check">L<input type="checkbox" class="day-opt" value="1"></label>
                    <label class="day-check">M<input type="checkbox" class="day-opt" value="2"></label>
                    <label class="day-check">X<input type="checkbox" class="day-opt" value="3"></label>
                    <label class="day-check">J<input type="checkbox" class="day-opt" value="4"></label>
                    <label class="day-check">V<input type="checkbox" class="day-opt" value="5"></label>
                    <label class="day-check">S<input type="checkbox" class="day-opt" value="6"></label>
                    <label class="day-check">D<input type="checkbox" class="day-opt" value="0"></label>
                </div>
            </div>

            <h4 style="margin-top: 15px;">Puntuaciones</h4>
            <div id="gt-scores"></div>
            
            <h4 style="margin-top: 15px;">Categor√≠as</h4>
            <input type="text" id="new-category" placeholder="Nueva categor√≠a (ej: Puntualidad)">
            <button class="secondary" onclick="addCategory()">+ A√±adir Categor√≠a</button>
            
            <button onclick="saveGlobalTask()" style="margin-top:10px;">Crear Tareas</button>
        </div>

        <!-- Editar Tareas Globales -->
        <div class="card">
            <h4>Tareas Globales Creadas</h4>
            <div id="global-tasks-list"></div>
        </div>

        <!-- Backup y Restauraci√≥n -->
        <div class="card">
            <h4>Copia de Seguridad</h4>
            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                Guarda todos tus datos (usuarios, tareas, puntuaciones). Se abrir√° el men√∫ de compartir de Android para que elijas d√≥nde guardarlo: Drive, Email, WhatsApp, etc.
            </p>
            <button onclick="exportBackup()" style="background: var(--success);">üì§ Compartir Backup</button>
            <button class="secondary" onclick="document.getElementById('import-file').click();" style="margin-top: 10px;">üì• Restaurar Backup</button>
            <input type="file" id="import-file" accept=".json,.txt" style="display:none;" onchange="importBackup(event)">
            
            <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
                <small style="color: #856404;">
                    <strong>‚ö†Ô∏è Importante:</strong> Al restaurar un backup, se reemplazar√°n todos los datos actuales. Guarda el archivo de backup en un lugar seguro (Drive, Email, etc.).
                </small>
            </div>
        </div>
    </div>

    <!-- Aplicaci√≥n principal -->
    <div id="main-app" style="display:none;">
        <div style="position: fixed; top: 0; left: 0; right: 0; background: #fff; padding: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 200; display: flex; justify-content: space-between; align-items: center;">
            <h2 id="user-title" style="margin: 0;">Tareas</h2>
            <button class="danger small" onclick="logout()">Salir</button>
        </div>

        <div style="padding-top: 70px;">
            <div id="view-tasks" class="screen">
                <div id="tasks-container"></div>
            </div>

            <div id="view-calendar" class="screen">
                <h3 style="margin-top: 0;">Calendario</h3>
                <div id="calendar-container"></div>
            </div>

            <div id="view-scores" class="screen">
                <h3 style="margin-top: 0;">Mi Puntuaci√≥n</h3>
                <div id="scores-container"></div>
            </div>
        </div>

        <nav class="nav-bottom">
            <button class="nav-btn" onclick="showView('view-tasks')">Tareas</button>
            <button class="nav-btn" onclick="showView('view-calendar')">Calendario</button>
            <button class="nav-btn" onclick="showView('view-scores')">Puntos</button>
        </nav>
    </div>

    <!-- Modal para cambiar estado de tarea -->
    <div id="status-modal" class="modal">
        <div class="modal-content">
            <h3>Cambiar estado de tarea</h3>
            <p id="modal-task-title"></p>
            <div class="task-actions">
                <button class="secondary" onclick="changeTaskStatus('En espera')">‚è≥ En espera</button>
                <button style="background: var(--info);" onclick="changeTaskStatus('En proceso')">üîÑ En proceso</button>
                <button style="background: var(--success);" onclick="changeTaskStatus('Terminada')">‚úÖ Terminada</button>
                <button class="danger" onclick="changeTaskStatus('Perdida')">‚ùå Perdida</button>
            </div>
            <button class="secondary" onclick="closeStatusModal()" style="margin-top: 15px;">Cancelar</button>
        </div>
    </div>

    <!-- Modal para editar tarea global -->
    <div id="edit-task-modal" class="modal">
        <div class="modal-content">
            <h3>Editar Tarea</h3>
            <input type="text" id="edit-task-title" placeholder="T√≠tulo">
            <input type="date" id="edit-task-date">
            
            <div style="margin: 10px 0;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="edit-task-repeat" onchange="toggleEditRepeat()" style="width: auto; margin: 0;"> 
                    ¬øSe repite?
                </label>
            </div>

            <div id="edit-repeat-options" style="display:none;">
                <p style="margin: 5px 0;"><strong>D√≠as de repetici√≥n:</strong></p>
                <div class="days-selector">
                    <label class="day-check">L<input type="checkbox" class="edit-day-opt" value="1"></label>
                    <label class="day-check">M<input type="checkbox" class="edit-day-opt" value="2"></label>
                    <label class="day-check">X<input type="checkbox" class="edit-day-opt" value="3"></label>
                    <label class="day-check">J<input type="checkbox" class="edit-day-opt" value="4"></label>
                    <label class="day-check">V<input type="checkbox" class="edit-day-opt" value="5"></label>
                    <label class="day-check">S<input type="checkbox" class="edit-day-opt" value="6"></label>
                    <label class="day-check">D<input type="checkbox" class="edit-day-opt" value="0"></label>
                </div>
            </div>

            <h4>Puntuaciones</h4>
            <div id="edit-task-scores"></div>

            <div class="modal-buttons">
                <button onclick="saveEditedTask()">Guardar</button>
                <button class="secondary" onclick="closeEditModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        const DB_VERSION = 2; // Incrementar cuando haya cambios en estructura
        
        let db = loadDatabase();
        let currentUser = null;
        let currentTaskId = null;
        let currentEditTaskGroupId = null;
        const dayNames = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];
        const dayNamesShort = ["D", "L", "M", "X", "J", "V", "S"];

        function loadDatabase() {
            const stored = localStorage.getItem('eliteDB');
            let data;
            
            if(!stored) {
                // Primera instalaci√≥n
                data = { 
                    version: DB_VERSION,
                    users: [], 
                    categories: ['Responsabilidad', 'Amabilidad', 'Respeto'],
                    globalTasks: []
                };
            } else {
                data = JSON.parse(stored);
                
                // Migrar datos si es necesario
                if(!data.version || data.version < DB_VERSION) {
                    data = migrateDatabase(data);
                }
            }
            
            return data;
        }

        function migrateDatabase(oldData) {
            // Si no tiene versi√≥n, es versi√≥n 1
            const currentVersion = oldData.version || 1;
            
            // Asegurar que existe la estructura b√°sica
            if(!oldData.globalTasks) oldData.globalTasks = [];
            if(!oldData.categories) oldData.categories = ['Responsabilidad', 'Amabilidad', 'Respeto'];
            if(!oldData.users) oldData.users = [];
            
            // Migraci√≥n de versi√≥n 1 a 2
            if(currentVersion < 2) {
                // Agregar groupId y baseTitle a tareas existentes si no lo tienen
                oldData.users.forEach(user => {
                    if(user.tasks) {
                        user.tasks.forEach(task => {
                            if(!task.groupId) {
                                task.groupId = 'legacy_' + task.id;
                            }
                            if(!task.baseTitle && task.title) {
                                task.baseTitle = task.title;
                            }
                        });
                    }
                });
            }
            
            oldData.version = DB_VERSION;
            save();
            return oldData;
        }

        function save() { 
            db.version = DB_VERSION;
            localStorage.setItem('eliteDB', JSON.stringify(db)); 
        }

        function navTo(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'screen-settings') renderSettings();
            if(id === 'screen-home') renderHome();
        }

        function renderHome() {
            const list = document.getElementById('users-list-home');
            list.innerHTML = '';
            if(db.users.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#999;">No hay usuarios. Crea uno en configuraci√≥n.</p>';
            } else {
                db.users.forEach(u => {
                    list.innerHTML += `<div class="user-item" onclick="login(${u.id})"><strong>${u.name}</strong><span>‚Üí</span></div>`;
                });
            }
        }

        function renderSettings() {
            // Usuarios
            const list = document.getElementById('users-manage-list');
            list.innerHTML = '';
            db.users.forEach(u => {
                list.innerHTML += `
                    <div class="user-item" style="cursor: default;">
                        <input type="text" value="${u.name}" onchange="updateUserName(${u.id}, this.value)" style="width: 60%; margin: 0;">
                        <button class="danger small" onclick="deleteUser(${u.id})">Eliminar</button>
                    </div>`;
            });

            // Lista asignaci√≥n usuarios
            const assignList = document.getElementById('gt-user-assign');
            assignList.innerHTML = '';
            if(db.users.length === 0) {
                assignList.innerHTML = '<p style="color:#999; font-size:12px;">Crea usuarios primero</p>';
            } else {
                db.users.forEach(u => {
                    assignList.innerHTML += `<label><input type="checkbox" class="assign-user" value="${u.id}"> ${u.name}</label>`;
                });
            }

            // Puntuaciones
            const scoresDiv = document.getElementById('gt-scores');
            scoresDiv.innerHTML = '';
            db.categories.forEach(cat => {
                scoresDiv.innerHTML += `<label>${cat} <input type="number" class="sc-in" data-cat="${cat}" value="0" min="0"></label>`;
            });

            // Tareas globales
            renderGlobalTasks();
        }

        function renderGlobalTasks() {
            const container = document.getElementById('global-tasks-list');
            container.innerHTML = '';
            
            // Agrupar por groupId
            const groups = {};
            db.globalTasks.forEach(gt => {
                if(!groups[gt.groupId]) groups[gt.groupId] = [];
                groups[gt.groupId].push(gt);
            });

            if(Object.keys(groups).length === 0) {
                container.innerHTML = '<p style="color:#999; font-size:12px;">No hay tareas globales creadas</p>';
                return;
            }

            Object.keys(groups).forEach(groupId => {
                const tasks = groups[groupId];
                const firstTask = tasks[0];
                const assignedUsers = db.users.filter(u => tasks.some(t => t.userId === u.id)).map(u => u.name).join(', ');
                
                // Ordenar d√≠as empezando por lunes
                const dayOrder = [1, 2, 3, 4, 5, 6, 0]; // L, M, X, J, V, S, D
                const daysText = firstTask.isRepeat ? 
                    dayOrder
                        .filter(d => firstTask.repeatDays.includes(d))
                        .map(d => dayNamesShort[d])
                        .join(', ') 
                    : '';
                
                container.innerHTML += `
                    <div class="card admin-task-card" style="position: relative; padding-right: 70px;">
                        <strong>${firstTask.baseTitle || firstTask.title}</strong><br>
                        <small>üìÖ ${firstTask.date || 'Sin fecha'}</small><br>
                        <small>üë• ${assignedUsers}</small><br>
                        ${firstTask.isRepeat ? '<small>üîÑ Repetitiva (' + daysText + ')</small>' : ''}
                        <button class="edit-task-btn" onclick="openEditTaskModal('${groupId}')">‚úèÔ∏è</button>
                    </div>
                `;
            });
        }

        function createUser() {
            const name = document.getElementById('new-user-name').value.trim();
            if(!name) return alert('Escribe un nombre');
            if(db.users.some(u => u.name === name)) return alert('Ya existe un usuario con ese nombre');
            
            db.users.push({ id: Date.now(), name, tasks: [] });
            save();
            document.getElementById('new-user-name').value = '';
            renderSettings();
            renderHome();
        }

        function updateUserName(id, name) {
            const u = db.users.find(u => u.id === id);
            if(u && name.trim()) {
                u.name = name.trim();
                save();
            }
        }

        function deleteUser(id) {
            if(!confirm('¬øBorrar usuario? Se eliminar√°n todas sus tareas.')) return;
            
            // Eliminar tareas globales asociadas
            db.globalTasks = db.globalTasks.filter(gt => gt.userId !== id);
            
            // Eliminar usuario
            db.users = db.users.filter(u => u.id !== id);
            save();
            renderSettings();
            renderHome();
        }

        function toggleRepeat() {
            document.getElementById('repeat-options').style.display = 
                document.getElementById('gt-repeat').checked ? 'block' : 'none';
        }

        function toggleEditRepeat() {
            document.getElementById('edit-repeat-options').style.display = 
                document.getElementById('edit-task-repeat').checked ? 'block' : 'none';
        }

        function addCategory() {
            const input = document.getElementById('new-category');
            const newCat = input.value.trim();
            
            if(!newCat) return alert('Escribe el nombre de la categor√≠a');
            if(db.categories.includes(newCat)) return alert('Esta categor√≠a ya existe');
            
            db.categories.push(newCat);
            save();
            input.value = '';
            renderSettings();
        }

        function exportBackup() {
            const dataStr = JSON.stringify(db, null, 2);
            
            const now = new Date();
            const timestamp = now.toISOString().split('T')[0] + '_' + 
                              now.getHours().toString().padStart(2, '0') + 
                              now.getMinutes().toString().padStart(2, '0') +
                              now.getSeconds().toString().padStart(2, '0');
            const fileName = `gestor_elite_backup_${timestamp}.json`;
            
            // Intentar usar Web Share API (mejor para m√≥viles)
            if (navigator.share && navigator.canShare) {
                // Crear archivo para compartir
                const blob = new Blob([dataStr], { type: 'application/json' });
                const file = new File([blob], fileName, { type: 'application/json' });
                
                if (navigator.canShare({ files: [file] })) {
                    navigator.share({
                        title: 'Backup Gestor Elite',
                        text: 'Copia de seguridad de Gestor Elite',
                        files: [file]
                    })
                    .then(() => {
                        console.log('Backup compartido exitosamente');
                    })
                    .catch((error) => {
                        console.log('Error al compartir:', error);
                        // Si falla, usar m√©todo alternativo
                        fallbackExport(dataStr, fileName);
                    });
                } else {
                    // Si no puede compartir archivos, usar m√©todo alternativo
                    fallbackExport(dataStr, fileName);
                }
            } else {
                // Navegador no soporta Web Share API
                fallbackExport(dataStr, fileName);
            }
        }

        function fallbackExport(dataStr, fileName) {
            // M√©todo alternativo: mostrar el contenido para copiar
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;';
            
            modal.innerHTML = `
                <div style="background:white;padding:20px;border-radius:12px;max-width:500px;width:100%;max-height:80vh;overflow:auto;">
                    <h3 style="margin-top:0;">Backup Generado</h3>
                    <p style="font-size:14px;color:#666;">El sistema de compartir no est√° disponible. Copia este texto y gu√°rdalo en un archivo:</p>
                    <textarea id="backup-text" readonly style="width:100%;height:300px;font-family:monospace;font-size:11px;padding:10px;border:1px solid #ddd;border-radius:5px;margin:10px 0;">${dataStr}</textarea>
                    <button onclick="copyBackupText()" style="width:100%;background:#4a90e2;color:white;border:none;padding:12px;border-radius:8px;font-weight:bold;margin-bottom:10px;">üìã Copiar al Portapapeles</button>
                    <button onclick="this.parentElement.parentElement.remove()" style="width:100%;background:#95a5a6;color:white;border:none;padding:12px;border-radius:8px;font-weight:bold;">Cerrar</button>
                    <p style="font-size:12px;color:#666;margin-top:10px;">üí° Pega el contenido en un editor de texto y gu√°rdalo como: <strong>${fileName}</strong></p>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function copyBackupText() {
            const textarea = document.getElementById('backup-text');
            textarea.select();
            textarea.setSelectionRange(0, 99999); // Para m√≥viles
            
            try {
                document.execCommand('copy');
                alert('‚úÖ Backup copiado al portapapeles!\n\nAhora puedes pegarlo en tu app de notas, email, Drive, etc.');
            } catch (err) {
                alert('‚ùå No se pudo copiar autom√°ticamente.\nPor favor, selecciona el texto manualmente y c√≥pialo.');
            }
        }

        function importBackup(event) {
            const file = event.target.files[0];
            if(!file) return;
            
            if(!confirm('‚ö†Ô∏è ¬øEst√°s seguro?\n\nSe reemplazar√°n TODOS los datos actuales con los del backup.\n\nEsta acci√≥n no se puede deshacer.')) {
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validar estructura b√°sica
                    if(!importedData.users || !Array.isArray(importedData.users)) {
                        throw new Error('Formato de backup inv√°lido');
                    }
                    
                    // Asegurar campos necesarios
                    if(!importedData.categories) importedData.categories = ['Responsabilidad', 'Amabilidad', 'Respeto'];
                    if(!importedData.globalTasks) importedData.globalTasks = [];
                    if(!importedData.version) importedData.version = DB_VERSION;
                    
                    // Migrar si es necesario
                    db = migrateDatabase(importedData);
                    save();
                    
                    alert('‚úÖ Backup restaurado correctamente!\n\nSe han importado:\n- ' + db.users.length + ' usuarios\n- ' + db.categories.length + ' categor√≠as');
                    
                    renderSettings();
                    renderHome();
                    
                } catch(error) {
                    alert('‚ùå Error al importar backup:\n' + error.message + '\n\nAseg√∫rate de seleccionar un archivo de backup v√°lido.');
                }
                
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        function login(id) {
            currentUser = db.users.find(u => u.id === id);
            document.getElementById('screen-home').classList.remove('active');
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('user-title').innerText = `Tareas de ${currentUser.name}`;
            showView('view-tasks');
        }

        function logout() {
            document.getElementById('main-app').style.display = 'none';
            currentUser = null;
            navTo('screen-home');
        }

        function showView(viewId) {
            document.querySelectorAll('#main-app .screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(viewId).classList.add('active');
            
            // Actualizar t√≠tulo del header
            const titles = {
                'view-tasks': 'Tareas de ' + currentUser.name,
                'view-calendar': 'Calendario de ' + currentUser.name,
                'view-scores': 'Puntuaci√≥n de ' + currentUser.name
            };
            document.getElementById('user-title').innerText = titles[viewId] || currentUser.name;
            
            const btnIndex = ['view-tasks', 'view-calendar', 'view-scores'].indexOf(viewId);
            if(btnIndex >= 0) {
                document.querySelectorAll('.nav-btn')[btnIndex].classList.add('active');
            }

            if(viewId === 'view-tasks') renderTasks();
            if(viewId === 'view-calendar') renderCalendar();
            if(viewId === 'view-scores') renderScores();
        }

        function saveGlobalTask() {
            const title = document.getElementById('gt-title').value.trim();
            const startDate = document.getElementById('gt-date').value;
            const isRepeat = document.getElementById('gt-repeat').checked;
            const assignedUsers = Array.from(document.querySelectorAll('.assign-user:checked')).map(el => parseInt(el.value));
            
            if(!title) return alert("Escribe un t√≠tulo para la tarea");
            if(assignedUsers.length === 0) return alert("Selecciona al menos un usuario");

            let scores = {};
            document.querySelectorAll('.sc-in').forEach(i => {
                scores[i.dataset.cat] = parseInt(i.value) || 0;
            });

            const groupId = 'group_' + Date.now();

            if(!isRepeat) {
                // Tarea simple
                assignedUsers.forEach(userId => {
                    const user = db.users.find(u => u.id === userId);
                    const taskId = Date.now() + Math.random();
                    
                    const task = {
                        id: taskId,
                        groupId: groupId,
                        title: title,
                        baseTitle: title,
                        date: startDate,
                        status: 'En espera',
                        scores: scores,
                        isRepeat: false,
                        userId: userId
                    };
                    
                    user.tasks.push(task);
                    db.globalTasks.push(task);
                });
            } else {
                // Tarea repetitiva
                const selectedDays = Array.from(document.querySelectorAll('.day-opt:checked')).map(el => parseInt(el.value));
                if(selectedDays.length === 0) return alert("Selecciona al menos un d√≠a de repetici√≥n");
                
                assignedUsers.forEach(userId => {
                    const user = db.users.find(u => u.id === userId);
                    createRepeatedTasks(user, title, startDate, selectedDays, scores, groupId, userId);
                });
            }

            save();
            alert("Tareas creadas correctamente");
            
            // Limpiar formulario
            document.getElementById('gt-title').value = '';
            document.getElementById('gt-date').value = '';
            document.getElementById('gt-repeat').checked = false;
            toggleRepeat();
            document.querySelectorAll('.assign-user').forEach(cb => cb.checked = false);
            document.querySelectorAll('.day-opt').forEach(cb => cb.checked = false);
            document.querySelectorAll('.sc-in').forEach(i => i.value = 0);
            
            renderSettings();
        }

        function createRepeatedTasks(user, title, startDateStr, days, scores, groupId, userId) {
            let current = startDateStr ? new Date(startDateStr + 'T00:00:00') : new Date();
            current.setHours(0, 0, 0, 0);
            
            let count = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Buscar primera ocurrencia (hoy o futura)
            while(count < 3) {
                if(days.includes(current.getDay())) {
                    const dateStr = current.toISOString().split('T')[0];
                    const taskId = Date.now() + Math.random() + count;
                    
                    const task = {
                        id: taskId,
                        groupId: groupId,
                        title: `${title}. ${dayNames[current.getDay()]}`,
                        baseTitle: title,
                        date: dateStr,
                        status: 'En espera',
                        scores: scores,
                        isRepeat: true,
                        repeatDays: days,
                        userId: userId
                    };
                    
                    user.tasks.push(task);
                    db.globalTasks.push(task);
                    count++;
                }
                current.setDate(current.getDate() + 1);
            }
        }

        function openEditTaskModal(groupId) {
            currentEditTaskGroupId = groupId;
            const tasks = db.globalTasks.filter(t => t.groupId === groupId);
            if(tasks.length === 0) return;
            
            const firstTask = tasks[0];
            
            document.getElementById('edit-task-title').value = firstTask.baseTitle || firstTask.title;
            document.getElementById('edit-task-date').value = firstTask.date || '';
            document.getElementById('edit-task-repeat').checked = firstTask.isRepeat;
            
            if(firstTask.isRepeat) {
                document.getElementById('edit-repeat-options').style.display = 'block';
                document.querySelectorAll('.edit-day-opt').forEach(cb => {
                    cb.checked = firstTask.repeatDays.includes(parseInt(cb.value));
                });
            } else {
                document.getElementById('edit-repeat-options').style.display = 'none';
            }
            
            // Puntuaciones
            const scoresDiv = document.getElementById('edit-task-scores');
            scoresDiv.innerHTML = '';
            db.categories.forEach(cat => {
                const val = firstTask.scores[cat] || 0;
                scoresDiv.innerHTML += `<label>${cat} <input type="number" class="edit-sc-in" data-cat="${cat}" value="${val}" min="0"></label>`;
            });
            
            document.getElementById('edit-task-modal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-task-modal').classList.remove('active');
            currentEditTaskGroupId = null;
        }

        function saveEditedTask() {
            if(!currentEditTaskGroupId) return;
            
            const title = document.getElementById('edit-task-title').value.trim();
            const date = document.getElementById('edit-task-date').value;
            const isRepeat = document.getElementById('edit-task-repeat').checked;
            
            if(!title) return alert("El t√≠tulo no puede estar vac√≠o");
            
            let scores = {};
            document.querySelectorAll('.edit-sc-in').forEach(i => {
                scores[i.dataset.cat] = parseInt(i.value) || 0;
            });
            
            const oldTasks = db.globalTasks.filter(t => t.groupId === currentEditTaskGroupId);
            const affectedUserIds = [...new Set(oldTasks.map(t => t.userId))];
            
            // Eliminar tareas antiguas del grupo
            db.globalTasks = db.globalTasks.filter(t => t.groupId !== currentEditTaskGroupId);
            affectedUserIds.forEach(userId => {
                const user = db.users.find(u => u.id === userId);
                if(user) {
                    user.tasks = user.tasks.filter(t => t.groupId !== currentEditTaskGroupId);
                }
            });
            
            // Crear nuevas tareas
            if(!isRepeat) {
                affectedUserIds.forEach(userId => {
                    const user = db.users.find(u => u.id === userId);
                    const taskId = Date.now() + Math.random();
                    
                    const task = {
                        id: taskId,
                        groupId: currentEditTaskGroupId,
                        title: title,
                        baseTitle: title,
                        date: date,
                        status: 'En espera',
                        scores: scores,
                        isRepeat: false,
                        userId: userId
                    };
                    
                    user.tasks.push(task);
                    db.globalTasks.push(task);
                });
            } else {
                const selectedDays = Array.from(document.querySelectorAll('.edit-day-opt:checked')).map(el => parseInt(el.value));
                if(selectedDays.length === 0) return alert("Selecciona al menos un d√≠a");
                
                affectedUserIds.forEach(userId => {
                    const user = db.users.find(u => u.id === userId);
                    createRepeatedTasks(user, title, date, selectedDays, scores, currentEditTaskGroupId, userId);
                });
            }
            
            save();
            alert("Tarea actualizada");
            closeEditModal();
            renderSettings();
        }

        function renderTasks() {
            const container = document.getElementById('tasks-container');
            container.innerHTML = '';
            
            // Filtrar tareas activas
            const activeTasks = currentUser.tasks.filter(t => 
                t.status === 'En espera' || t.status === 'En proceso'
            );
            
            if(activeTasks.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; margin-top:40px;">No tienes tareas pendientes üéâ</p>';
                return;
            }
            
            activeTasks.forEach(t => {
                let statusClass = 'espera';
                if(t.status === 'En proceso') statusClass = 'proceso';
                
                container.innerHTML += `
                    <div class="card task-card st-${statusClass}" onclick="openStatusModal(${t.id})">
                        <span class="status-indicator status-${statusClass}">${t.status}</span>
                        <h4 style="margin: 5px 0;">${t.title}</h4>
                        <small>üìÖ ${t.date || 'Sin fecha'}</small>
                        ${t.isRepeat ? '<br><small style="color: var(--primary);">üîÑ Repetitiva</small>' : ''}
                    </div>
                `;
            });
        }

        function openStatusModal(taskId) {
            currentTaskId = taskId;
            const task = currentUser.tasks.find(t => t.id === taskId);
            if(!task) return;
            
            document.getElementById('modal-task-title').innerText = task.title;
            document.getElementById('status-modal').classList.add('active');
        }

        function closeStatusModal() {
            document.getElementById('status-modal').classList.remove('active');
            currentTaskId = null;
        }

        function changeTaskStatus(newStatus) {
            if(!currentTaskId) return;
            
            const task = currentUser.tasks.find(t => t.id === currentTaskId);
            if(!task) return;
            
            task.status = newStatus;
            
            // Si se completa o pierde una tarea repetitiva, generar siguiente
            if((newStatus === 'Terminada' || newStatus === 'Perdida') && task.isRepeat && task.repeatDays) {
                generateNextRepeatingTask(task);
            }
            
            save();
            closeStatusModal();
            renderTasks();
            renderCalendar();
            renderScores();
        }

        function generateNextRepeatingTask(completedTask) {
            // Contar cu√°ntas tareas futuras hay del mismo grupo
            const futureTasks = currentUser.tasks.filter(t => 
                t.groupId === completedTask.groupId && 
                (t.status === 'En espera' || t.status === 'En proceso') &&
                t.id !== completedTask.id
            );
            
            // Solo generar si hay menos de 3 tareas futuras
            if(futureTasks.length >= 3) return;
            
            const taskDate = new Date(completedTask.date + 'T00:00:00');
            let nextDate = new Date(taskDate);
            nextDate.setDate(nextDate.getDate() + 1);
            
            let found = false;
            let attempts = 0;
            
            // Buscar siguiente ocurrencia (m√°ximo 30 d√≠as adelante)
            while(!found && attempts < 30) {
                if(completedTask.repeatDays.includes(nextDate.getDay())) {
                    const nextDateStr = nextDate.toISOString().split('T')[0];
                    
                    // Verificar que no exista ya
                    const exists = currentUser.tasks.some(t => 
                        t.groupId === completedTask.groupId && 
                        t.date === nextDateStr
                    );
                    
                    if(!exists) {
                        const newTaskId = Date.now() + Math.random();
                        const newTask = {
                            id: newTaskId,
                            groupId: completedTask.groupId,
                            title: `${completedTask.baseTitle}. ${dayNames[nextDate.getDay()]}`,
                            baseTitle: completedTask.baseTitle,
                            date: nextDateStr,
                            status: 'En espera',
                            scores: completedTask.scores,
                            isRepeat: true,
                            repeatDays: completedTask.repeatDays,
                            userId: currentUser.id
                        };
                        
                        currentUser.tasks.push(newTask);
                        
                        // Actualizar en db.users
                        const userIndex = db.users.findIndex(u => u.id === currentUser.id);
                        db.users[userIndex] = currentUser;
                        
                        found = true;
                    }
                }
                nextDate.setDate(nextDate.getDate() + 1);
                attempts++;
            }
        }

        function renderCalendar() {
            const container = document.getElementById('calendar-container');
            container.innerHTML = '';
            
            const datedTasks = currentUser.tasks
                .filter(t => t.date)
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if(datedTasks.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; margin-top:40px;">No hay tareas con fecha asignada</p>';
                return;
            }
            
            let lastDate = '';
            datedTasks.forEach(t => {
                if(t.date !== lastDate) {
                    const dateObj = new Date(t.date + 'T00:00:00');
                    const dayName = dayNames[dateObj.getDay()];
                    container.innerHTML += `<h3 style="color: var(--primary); margin-top: 20px; border-bottom: 2px solid var(--primary); padding-bottom: 5px;">${t.date} - ${dayName}</h3>`;
                    lastDate = t.date;
                }
                
                let statusClass = 'espera';
                if(t.status === 'En proceso') statusClass = 'proceso';
                if(t.status === 'Terminada') statusClass = 'terminada';
                if(t.status === 'Perdida') statusClass = 'perdida';
                
                container.innerHTML += `
                    <div class="card st-${statusClass}" style="border-left: 4px solid;">
                        <span class="status-indicator status-${statusClass}">${t.status}</span>
                        <strong>${t.title}</strong>
                    </div>
                `;
            });
        }

        function renderScores() {
            const container = document.getElementById('scores-container');
            container.innerHTML = '';
            
            let totals = {};
            db.categories.forEach(c => totals[c] = 0);

            currentUser.tasks.forEach(t => {
                if(t.status === 'Terminada') {
                    for(let cat in t.scores) {
                        if(!totals[cat]) totals[cat] = 0;
                        totals[cat] += t.scores[cat];
                    }
                }
            });

            for(let cat in totals) {
                container.innerHTML += `
                    <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
                        <strong style="font-size: 18px;">${cat}</strong> 
                        <span style="font-size: 24px; color: var(--success); font-weight: bold;">${totals[cat]}</span>
                    </div>
                `;
            }
        }

        // Inicializar
        renderHome();
    </script>
</body>
</html>