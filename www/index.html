<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gestor Elite</title>
    <style>
        :root { 
            --primary: #4a90e2; 
            --bg: #f0f2f5; 
            --card: #ffffff; 
            --danger: #ff4d4d; 
            --success: #2ecc71;
            --warning: #f39c12;
            --info: #3498db;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding-bottom: 70px; 
        }
        .screen { 
            display: none; 
            padding: 20px; 
            animation: fadeIn 0.3s; 
        }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .card { 
            background: var(--card); 
            padding: 15px; 
            margin-bottom: 15px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
        }
        button { 
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 8px; 
            font-weight: bold; 
            width: 100%; 
            cursor: pointer; 
            margin-top: 5px;
        }
        button.secondary { background: #95a5a6; color: #fff; }
        button.danger { background: var(--danger); }
        button.small { width: auto; padding: 8px 12px; font-size: 12px; }
        
        input, select, textarea { 
            width: 100%; 
            padding: 10px; 
            margin: 5px 0; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            box-sizing: border-box; 
        }
        
        .user-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px; 
            background: white; 
            margin-bottom: 10px; 
            border-radius: 12px; 
            border: 1px solid #eee;
            cursor: pointer;
            transition: all 0.2s;
        }
        .user-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        .settings-btn { 
            font-size: 50px; 
            background: none; 
            border: none; 
            color: #888; 
            cursor: pointer; 
            display: block; 
            margin: 30px auto; 
            width: auto;
            transition: transform 0.3s;
        }
        .settings-btn:hover { transform: rotate(90deg); }

        .task-card { 
            border-left: 5px solid #ccc; 
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .st-espera { border-left-color: var(--warning); }
        .st-proceso { border-left-color: var(--info); }
        .st-terminada { border-left-color: var(--success); }
        .st-perdida { border-left-color: var(--danger); opacity: 0.7; }

        .status-indicator {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .status-espera { background: var(--warning); color: #fff; }
        .status-proceso { background: var(--info); color: #fff; }
        .status-terminada { background: var(--success); color: #fff; }
        .status-perdida { background: var(--danger); color: #fff; }

        .task-scores {
            font-size: 11px;
            color: #666;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #ddd;
        }
        .task-scores span {
            display: inline-block;
            margin-right: 10px;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .days-selector { 
            display: flex; 
            justify-content: space-between; 
            margin: 10px 0; 
            flex-wrap: wrap;
            gap: 5px;
        }
        .day-check { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-size: 10px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex: 1;
            min-width: 40px;
        }

        .user-checkbox-list { 
            max-height: 150px; 
            overflow-y: auto; 
            border: 1px solid #ddd; 
            padding: 10px; 
            border-radius: 5px; 
            margin: 10px 0;
        }
        .user-checkbox-list label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 0;
        }
        .user-checkbox-list input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .nav-bottom { 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            background: #fff; 
            display: flex; 
            border-top: 1px solid #ddd; 
            height: 60px; 
            z-index: 100;
        }
        .nav-btn { 
            flex: 1; 
            border: none; 
            background: none; 
            font-size: 12px; 
            color: #999; 
            cursor: pointer;
        }
        .nav-btn.active { color: var(--primary); font-weight: bold; }

        .config-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
        }
        .config-tab {
            padding: 10px 15px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 14px;
            font-weight: normal;
            white-space: nowrap;
            width: auto;
            margin-top: 0;
        }
        .config-tab.active {
            background: var(--primary);
            color: white;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            max-width: 95%;
            width: 400px;
            max-height: 80%;
            overflow-y: auto;
            box-sizing: border-box;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .modal-buttons button {
            flex: 1;
        }

        .task-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .task-actions button {
            flex: 1;
            min-width: 80px;
            font-size: 11px;
            padding: 8px;
        }

        .admin-task-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }

        .edit-task-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 10px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .badge-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .badge-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .badge-image {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            background: #f0f0f0;
        }
        .badge-image.locked {
            filter: grayscale(100%);
            opacity: 0.5;
        }
        .badge-image.unlocked {
            filter: grayscale(0%);
            opacity: 1;
        }
        .badge-name {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .badge-progress {
            font-size: 10px;
            color: #666;
        }
        .badge-config-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .badge-emoji-display {
            font-size: 40px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 8px;
        }

        .category-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .category-item input {
            flex: 1;
            margin: 0;
        }
        .drag-handle {
            cursor: move;
            font-size: 20px;
            color: #999;
        }
    </style>
</head>
<body>
    <!-- Pantalla de inicio -->
    <div id="screen-home" class="screen active">
        <h2 style="text-align: center; margin-top: 40px;">Hola, ¬øqui√©n eres?</h2>
        <p style="text-align: center; color: #666;">Selecciona tu perfil</p>
        <div id="users-list-home"></div>
        
        <button class="settings-btn" onclick="navTo('screen-settings')">‚öôÔ∏è</button>
    </div>

    <!-- Pantalla de configuraci√≥n -->
    <div id="screen-settings" class="screen">
        <button class="secondary small" onclick="navTo('screen-home')" style="margin-bottom: 15px;">‚¨Ö Volver</button>
        <h3>Configuraci√≥n</h3>
        
        <div class="config-tabs">
            <button class="config-tab active" onclick="showConfigTab('tab-users')">üë• Usuarios</button>
            <button class="config-tab" onclick="showConfigTab('tab-tasks')">üìã Tareas</button>
            <button class="config-tab" onclick="showConfigTab('tab-badges')">üéñÔ∏è Insignias</button>
            <button class="config-tab" onclick="showConfigTab('tab-backup')">üíæ Backup</button>
        </div>

        <!-- TAB: Usuarios -->
        <div id="tab-users" class="config-tab-content">
            <div class="card">
                <h4>Gestionar Usuarios</h4>
                <input type="text" id="new-user-name" placeholder="Nombre nuevo usuario">
                <button onclick="createUser()">A√±adir Usuario</button>
                <div id="users-manage-list" style="margin-top:15px;"></div>
            </div>

            <div class="card">
                <h4>Editar Puntuaciones de Usuarios</h4>
                <p style="font-size: 12px; color: #666;">Modifica directamente los puntos de cada usuario</p>
                <select id="edit-scores-user" onchange="loadUserScores()">
                    <option value="">Selecciona un usuario</option>
                </select>
                <div id="user-scores-editor" style="display:none; margin-top:10px;"></div>
            </div>
        </div>

        <!-- TAB: Tareas -->
        <div id="tab-tasks" class="config-tab-content" style="display:none;">
            <div class="card">
                <h4>Gesti√≥n de Categor√≠as</h4>
                <p style="font-size: 12px; color: #666;">A√±ade, edita o elimina categor√≠as. Arrastra para reordenar.</p>
                <input type="text" id="new-category" placeholder="Nueva categor√≠a (ej: Puntualidad)">
                <button onclick="addCategory()">+ A√±adir Categor√≠a</button>
                <div id="categories-list" style="margin-top: 15px;"></div>
            </div>

            <div class="card">
                <h4>Crear Tarea Global</h4>
                <input type="text" id="gt-title" placeholder="T√≠tulo de la tarea">
                <label style="font-size: 12px; color: #666; margin-top: 5px;">Fecha (opcional):</label>
                <input type="date" id="gt-date">
                
                <p style="margin: 10px 0 5px 0;"><strong>Asignar a:</strong></p>
                <div id="gt-user-assign" class="user-checkbox-list"></div>

                <div style="margin: 10px 0;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="gt-repeat" onchange="toggleRepeat()" style="width: auto; margin: 0;"> 
                        ¬øSe repite?
                    </label>
                </div>

                <div id="repeat-options" style="display:none;">
                    <p style="margin: 5px 0;"><strong>D√≠as de repetici√≥n:</strong></p>
                    <div class="days-selector">
                        <label class="day-check">L<input type="checkbox" class="day-opt" value="1"></label>
                        <label class="day-check">M<input type="checkbox" class="day-opt" value="2"></label>
                        <label class="day-check">X<input type="checkbox" class="day-opt" value="3"></label>
                        <label class="day-check">J<input type="checkbox" class="day-opt" value="4"></label>
                        <label class="day-check">V<input type="checkbox" class="day-opt" value="5"></label>
                        <label class="day-check">S<input type="checkbox" class="day-opt" value="6"></label>
                        <label class="day-check">D<input type="checkbox" class="day-opt" value="0"></label>
                    </div>
                </div>

                <h4 style="margin-top: 15px;">Puntuaciones</h4>
                <div id="gt-scores"></div>
                
                <button onclick="saveGlobalTask()" style="margin-top:10px;">Crear Tareas</button>
            </div>

            <div class="card">
                <h4>Tareas Globales Creadas</h4>
                <div id="global-tasks-list"></div>
            </div>
        </div>

        <!-- TAB: Insignias -->
        <div id="tab-badges" class="config-tab-content" style="display:none;">
            <div class="card">
                <h4>Crear Insignia</h4>
                <p style="font-size: 12px; color: #666;">Crea insignias que se desbloquean al alcanzar puntos</p>
                
                <label style="font-size: 12px;">Nombre de la insignia:</label>
                <input type="text" id="badge-name" placeholder="Ej: Maestro del Orden">
                
                <label style="font-size: 12px;">Emoji/Icono:</label>
                <input type="text" id="badge-emoji" placeholder="Ej: üèÜ ‚≠ê üéñÔ∏è üëë" maxlength="2">
                
                <label style="font-size: 12px;">Tipo de requisito:</label>
                <select id="badge-req-type" onchange="toggleBadgeRequirements()">
                    <option value="total">Puntos totales (suma de todas las categor√≠as)</option>
                    <option value="category">Puntos en categor√≠a espec√≠fica</option>
                    <option value="multiple">Puntos en m√∫ltiples categor√≠as</option>
                </select>
                
                <div id="badge-total-req" style="margin-top: 10px;">
                    <label style="font-size: 12px;">Puntos totales necesarios:</label>
                    <input type="number" id="badge-total-points" placeholder="Ej: 10" min="1">
                </div>

                <div id="badge-category-req" style="display: none; margin-top: 10px;">
                    <label style="font-size: 12px;">Categor√≠a:</label>
                    <select id="badge-category"></select>
                    <label style="font-size: 12px;">Puntos necesarios:</label>
                    <input type="number" id="badge-category-points" placeholder="Ej: 100" min="1">
                </div>

                <div id="badge-multiple-req" style="display: none; margin-top: 10px;">
                    <p style="font-size: 12px;"><strong>Puntos necesarios por categor√≠a:</strong></p>
                    <div id="badge-multiple-scores"></div>
                </div>
                
                <button onclick="addBadge()" style="background: var(--success); margin-top: 10px;">+ A√±adir Insignia</button>
            </div>

            <div class="card">
                <h4>Insignias Creadas</h4>
                <div id="badges-list"></div>
            </div>
        </div>

        <!-- TAB: Backup -->
        <div id="tab-backup" class="config-tab-content" style="display:none;">
            <div class="card">
                <h4>Copia de Seguridad</h4>
                <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                    Guarda todos tus datos (usuarios, tareas, puntuaciones, insignias).
                </p>
                <button onclick="exportBackup()" style="background: var(--success);">üì§ Compartir/Crear Backup</button>
                
                <h4 style="margin-top: 20px;">Restaurar Backup</h4>
                <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                    Elige c√≥mo quieres restaurar tus datos:
                </p>
                <button class="secondary" onclick="showPasteBackup()">üìã Pegar Backup</button>
                <button class="secondary" onclick="document.getElementById('import-file').click();" style="margin-top: 10px;">üìÅ Subir Archivo</button>
                <input type="file" id="import-file" accept=".json,.txt" style="display:none;" onchange="importBackup(event)">
                
                <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
                    <small style="color: #856404;">
                        <strong>‚ö†Ô∏è Importante:</strong> Al restaurar un backup, se reemplazar√°n todos los datos actuales.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Aplicaci√≥n principal -->
    <div id="main-app" style="display:none;">
        <div style="position: fixed; top: 0; left: 0; right: 0; background: #fff; padding: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 200; display: flex; justify-content: space-between; align-items: center;">
            <h2 id="user-title" style="margin: 0;">Tareas</h2>
            <button class="danger small" onclick="logout()">Salir</button>
        </div>

        <div style="padding-top: 70px;">
            <div id="view-tasks" class="screen">
                <div id="tasks-container"></div>
            </div>

            <div id="view-calendar" class="screen">
                <h3 style="margin-top: 0;">Calendario</h3>
                <div id="calendar-container"></div>
            </div>

            <div id="view-scores" class="screen">
                <h3 style="margin-top: 0;">Mi Puntuaci√≥n</h3>
                <div id="scores-container"></div>
            </div>

            <div id="view-badges" class="screen">
                <h3 style="margin-top: 0;">Mis Insignias</h3>
                <div id="badges-container"></div>
            </div>
        </div>

        <nav class="nav-bottom">
            <button class="nav-btn" onclick="showView('view-tasks')">Tareas</button>
            <button class="nav-btn" onclick="showView('view-calendar')">Calendario</button>
            <button class="nav-btn" onclick="showView('view-scores')">Puntos</button>
            <button class="nav-btn" onclick="showView('view-badges')">Insignias</button>
        </nav>
    </div>
    <!-- Modal para cambiar estado de tarea -->
    <div id="status-modal" class="modal">
        <div class="modal-content">
            <h3>Cambiar estado de tarea</h3>
            <p id="modal-task-title"></p>
            <div class="task-actions">
                <button class="secondary" onclick="changeTaskStatus('En espera')">‚è≥ En espera</button>
                <button style="background: var(--info);" onclick="changeTaskStatus('En proceso')">üîÑ En proceso</button>
                <button style="background: var(--success);" onclick="changeTaskStatus('Terminada')">‚úÖ Terminada</button>
                <button class="danger" onclick="changeTaskStatus('Perdida')">‚ùå Perdida</button>
            </div>
            <button class="secondary" onclick="closeStatusModal()" style="margin-top: 15px;">Cancelar</button>
        </div>
    </div>

    <!-- Modal para editar tarea global -->
    <div id="edit-task-modal" class="modal">
        <div class="modal-content">
            <h3>Editar Tarea</h3>
            <input type="text" id="edit-task-title" placeholder="T√≠tulo">
            <input type="date" id="edit-task-date">
            
            <p style="margin: 10px 0 5px 0;"><strong>Asignar a:</strong></p>
            <div id="edit-task-user-assign" class="user-checkbox-list"></div>

            <div style="margin: 10px 0;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="edit-task-repeat" onchange="toggleEditRepeat()" style="width: auto; margin: 0;"> 
                    ¬øSe repite?
                </label>
            </div>

            <div id="edit-repeat-options" style="display:none;">
                <p style="margin: 5px 0;"><strong>D√≠as de repetici√≥n:</strong></p>
                <div class="days-selector">
                    <label class="day-check">L<input type="checkbox" class="edit-day-opt" value="1"></label>
                    <label class="day-check">M<input type="checkbox" class="edit-day-opt" value="2"></label>
                    <label class="day-check">X<input type="checkbox" class="edit-day-opt" value="3"></label>
                    <label class="day-check">J<input type="checkbox" class="edit-day-opt" value="4"></label>
                    <label class="day-check">V<input type="checkbox" class="edit-day-opt" value="5"></label>
                    <label class="day-check">S<input type="checkbox" class="edit-day-opt" value="6"></label>
                    <label class="day-check">D<input type="checkbox" class="edit-day-opt" value="0"></label>
                </div>
            </div>

            <h4>Puntuaciones</h4>
            <div id="edit-task-scores"></div>

            <div class="modal-buttons">
                <button onclick="saveEditedTask()">Guardar</button>
                <button class="secondary" onclick="closeEditModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para pegar backup -->
    <div id="paste-backup-modal" class="modal">
        <div class="modal-content">
            <h3>Pegar Backup</h3>
            <p style="font-size: 12px; color: #666;">Pega aqu√≠ el contenido del backup que copiaste:</p>
            <textarea id="paste-backup-text" placeholder="Pega aqu√≠ el backup..." style="width:100%;height:250px;font-family:monospace;font-size:11px;padding:10px;border:1px solid #ddd;border-radius:5px;margin:10px 0;box-sizing:border-box;"></textarea>
            <div class="modal-buttons">
                <button onclick="processPastedBackup()" style="background: var(--success);">‚úÖ Restaurar</button>
                <button class="secondary" onclick="closePasteBackupModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para editar insignia -->
    <div id="edit-badge-modal" class="modal">
        <div class="modal-content">
            <h3>Editar Insignia</h3>
            <input type="text" id="edit-badge-name" placeholder="Nombre">
            <input type="text" id="edit-badge-emoji" placeholder="Emoji" maxlength="2">
            
            <label style="font-size: 12px;">Tipo de requisito:</label>
            <select id="edit-badge-req-type" onchange="toggleEditBadgeRequirements()">
                <option value="total">Puntos totales</option>
                <option value="category">Categor√≠a espec√≠fica</option>
                <option value="multiple">M√∫ltiples categor√≠as</option>
            </select>
            
            <div id="edit-badge-total-req" style="margin-top: 10px;">
                <input type="number" id="edit-badge-total-points" placeholder="Puntos totales" min="1">
            </div>

            <div id="edit-badge-category-req" style="display: none; margin-top: 10px;">
                <select id="edit-badge-category"></select>
                <input type="number" id="edit-badge-category-points" placeholder="Puntos" min="1">
            </div>

            <div id="edit-badge-multiple-req" style="display: none; margin-top: 10px;">
                <div id="edit-badge-multiple-scores"></div>
            </div>

            <div class="modal-buttons">
                <button onclick="saveEditedBadge()">Guardar</button>
                <button class="secondary" onclick="closeEditBadgeModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        const DB_VERSION = 4;
        
        let db = loadDatabase();
        let currentUser = null;
        let currentTaskId = null;
        let currentEditTaskGroupId = null;
        let currentEditBadgeId = null;
        const dayNames = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];
        const dayNamesShort = ["D", "L", "M", "X", "J", "V", "S"];

        function loadDatabase() {
            const stored = localStorage.getItem('eliteDB');
            let data;
            
            if(!stored) {
                data = { 
                    version: DB_VERSION,
                    users: [], 
                    categories: ['Responsabilidad', 'Amabilidad', 'Respeto'],
                    globalTasks: [],
                    badges: []
                };
            } else {
                data = JSON.parse(stored);
                if(!data.version || data.version < DB_VERSION) {
                    data = migrateDatabase(data);
                }
            }
            
            return data;
        }

        function migrateDatabase(oldData) {
            const currentVersion = oldData.version || 1;
            
            if(!oldData.globalTasks) oldData.globalTasks = [];
            if(!oldData.categories) oldData.categories = ['Responsabilidad', 'Amabilidad', 'Respeto'];
            if(!oldData.users) oldData.users = [];
            if(!oldData.badges) oldData.badges = [];
            
            if(currentVersion < 2) {
                oldData.users.forEach(user => {
                    if(user.tasks) {
                        user.tasks.forEach(task => {
                            if(!task.groupId) task.groupId = 'legacy_' + task.id;
                            if(!task.baseTitle && task.title) task.baseTitle = task.title;
                        });
                    }
                });
            }
            
            if(currentVersion < 3) {
                oldData.users.forEach(user => {
                    if(!user.customScores) {
                        user.customScores = {};
                        oldData.categories.forEach(cat => {
                            user.customScores[cat] = 0;
                        });
                    }
                });
            }

            if(currentVersion < 4) {
                oldData.badges.forEach(badge => {
                    if(!badge.requirementType) {
                        if(badge.category && badge.points) {
                            badge.requirementType = 'category';
                            badge.categoryRequirement = {
                                category: badge.category,
                                points: badge.points
                            };
                        } else {
                            badge.requirementType = 'total';
                            badge.totalPoints = badge.points || 0;
                        }
                    }
                });
            }
            
            oldData.version = DB_VERSION;
            save();
            return oldData;
        }

        function save() { 
            db.version = DB_VERSION;
            localStorage.setItem('eliteDB', JSON.stringify(db)); 
        }

        // Verificar tareas expiradas
        function checkExpiredTasks() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];

            db.users.forEach(user => {
                user.tasks.forEach(task => {
                    if(task.date && task.date < todayStr && task.status !== 'Terminada' && task.status !== 'Perdida') {
                        task.status = 'Perdida';
                    }
                });
            });
            save();
        }

        setInterval(checkExpiredTasks, 60000);
        checkExpiredTasks();

        function navTo(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'screen-settings') {
                showConfigTab('tab-users');
                renderSettings();
            }
            if(id === 'screen-home') renderHome();
        }

        function showConfigTab(tabId) {
            document.querySelectorAll('.config-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.config-tab-content').forEach(c => c.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById(tabId).style.display = 'block';
            
            if(tabId === 'tab-users') renderUsersTab();
            if(tabId === 'tab-tasks') renderTasksTab();
            if(tabId === 'tab-badges') renderBadgesTab();
        }
        function renderHome() {
            const list = document.getElementById('users-list-home');
            list.innerHTML = '';
            if(db.users.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#999;">No hay usuarios. Crea uno en configuraci√≥n.</p>';
            } else {
                db.users.forEach(u => {
                    list.innerHTML += `<div class="user-item" onclick="login(${u.id})"><strong>${u.name}</strong><span>‚Üí</span></div>`;
                });
            }
        }

        function renderSettings() {
            renderUsersTab();
            renderTasksTab();
            renderBadgesTab();
        }

        function renderUsersTab() {
            const list = document.getElementById('users-manage-list');
            list.innerHTML = '';
            db.users.forEach(u => {
                list.innerHTML += `
                    <div class="user-item" style="cursor: default;">
                        <input type="text" value="${u.name}" onchange="updateUserName(${u.id}, this.value)" style="width: 60%; margin: 0;">
                        <button class="danger small" onclick="deleteUser(${u.id})">Eliminar</button>
                    </div>`;
            });

            const editScoresSelect = document.getElementById('edit-scores-user');
            editScoresSelect.innerHTML = '<option value="">Selecciona un usuario</option>';
            db.users.forEach(u => {
                editScoresSelect.innerHTML += `<option value="${u.id}">${u.name}</option>`;
            });
        }

        function renderTasksTab() {
            const catList = document.getElementById('categories-list');
            catList.innerHTML = '';
            db.categories.forEach((cat, index) => {
                catList.innerHTML += `
                    <div class="category-item" draggable="true" ondragstart="dragCategory(event, ${index})" ondragover="allowDrop(event)" ondrop="dropCategory(event, ${index})">
                        <span class="drag-handle">‚ò∞</span>
                        <input type="text" value="${cat}" onchange="editCategory(${index}, this.value)">
                        <button class="danger small" onclick="deleteCategory(${index})">Eliminar</button>
                    </div>
                `;
            });

            const assignList = document.getElementById('gt-user-assign');
            assignList.innerHTML = '';
            if(db.users.length === 0) {
                assignList.innerHTML = '<p style="color:#999; font-size:12px;">Crea usuarios primero</p>';
            } else {
                db.users.forEach(u => {
                    assignList.innerHTML += `<label><input type="checkbox" class="assign-user" value="${u.id}"> ${u.name}</label>`;
                });
            }

            const scoresDiv = document.getElementById('gt-scores');
            scoresDiv.innerHTML = '';
            db.categories.forEach(cat => {
                scoresDiv.innerHTML += `<label>${cat} <input type="number" class="sc-in" data-cat="${cat}" value="0" min="0"></label>`;
            });

            renderGlobalTasks();
        }

        function renderBadgesTab() {
            const badgeCatSelect = document.getElementById('badge-category');
            badgeCatSelect.innerHTML = '';
            db.categories.forEach(cat => {
                badgeCatSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
            });

            const multiScores = document.getElementById('badge-multiple-scores');
            multiScores.innerHTML = '';
            db.categories.forEach(cat => {
                multiScores.innerHTML += `<label>${cat} <input type="number" class="badge-multi-score" data-cat="${cat}" value="0" min="0"></label>`;
            });

            renderBadgesList();
        }

        let draggedCatIndex = -1;
        function dragCategory(e, index) {
            draggedCatIndex = index;
            e.dataTransfer.effectAllowed = 'move';
        }
        function allowDrop(e) {
            e.preventDefault();
        }
        function dropCategory(e, targetIndex) {
            e.preventDefault();
            if(draggedCatIndex === targetIndex) return;
            
            const cat = db.categories.splice(draggedCatIndex, 1)[0];
            db.categories.splice(targetIndex, 0, cat);
            save();
            renderTasksTab();
        }

        function addCategory() {
            const input = document.getElementById('new-category');
            const newCat = input.value.trim();
            
            if(!newCat) return alert('Escribe el nombre de la categor√≠a');
            if(db.categories.includes(newCat)) return alert('Esta categor√≠a ya existe');
            
            db.categories.push(newCat);
            db.users.forEach(user => {
                if(!user.customScores) user.customScores = {};
                user.customScores[newCat] = 0;
            });
            
            save();
            input.value = '';
            renderTasksTab();
        }

        function editCategory(index, newName) {
            newName = newName.trim();
            if(!newName) return alert('El nombre no puede estar vac√≠o');
            if(db.categories.includes(newName) && db.categories[index] !== newName) {
                return alert('Ya existe una categor√≠a con ese nombre');
            }
            
            const oldName = db.categories[index];
            db.categories[index] = newName;
            
            db.users.forEach(user => {
                user.tasks.forEach(task => {
                    if(task.scores && task.scores[oldName] !== undefined) {
                        task.scores[newName] = task.scores[oldName];
                        delete task.scores[oldName];
                    }
                });
                if(user.customScores && user.customScores[oldName] !== undefined) {
                    user.customScores[newName] = user.customScores[oldName];
                    delete user.customScores[oldName];
                }
            });
            
            db.globalTasks.forEach(task => {
                if(task.scores && task.scores[oldName] !== undefined) {
                    task.scores[newName] = task.scores[oldName];
                    delete task.scores[oldName];
                }
            });
            
            save();
            renderTasksTab();
        }

        function deleteCategory(index) {
            if(!confirm('¬øEliminar esta categor√≠a? Se eliminar√° de todas las tareas.')) return;
            
            const catName = db.categories[index];
            db.categories.splice(index, 1);
            
            db.users.forEach(user => {
                user.tasks.forEach(task => {
                    if(task.scores) delete task.scores[catName];
                });
                if(user.customScores) delete user.customScores[catName];
            });
            
            db.globalTasks.forEach(task => {
                if(task.scores) delete task.scores[catName];
            });
            
            save();
            renderTasksTab();
        }

        function toggleBadgeRequirements() {
            const type = document.getElementById('badge-req-type').value;
            document.getElementById('badge-total-req').style.display = type === 'total' ? 'block' : 'none';
            document.getElementById('badge-category-req').style.display = type === 'category' ? 'block' : 'none';
            document.getElementById('badge-multiple-req').style.display = type === 'multiple' ? 'block' : 'none';
        }

        function toggleEditBadgeRequirements() {
            const type = document.getElementById('edit-badge-req-type').value;
            document.getElementById('edit-badge-total-req').style.display = type === 'total' ? 'block' : 'none';
            document.getElementById('edit-badge-category-req').style.display = type === 'category' ? 'block' : 'none';
            document.getElementById('edit-badge-multiple-req').style.display = type === 'multiple' ? 'block' : 'none';
        }

        function addBadge() {
            const name = document.getElementById('badge-name').value.trim();
            const emoji = document.getElementById('badge-emoji').value.trim();
            const reqType = document.getElementById('badge-req-type').value;
            
            if(!name || !emoji) return alert('Completa nombre y emoji');
            
            const badge = {
                id: Date.now(),
                name: name,
                emoji: emoji,
                requirementType: reqType
            };
            
            if(reqType === 'total') {
                const points = parseInt(document.getElementById('badge-total-points').value);
                if(!points || points < 1) return alert('Especifica los puntos totales');
                badge.totalPoints = points;
            } else if(reqType === 'category') {
                const category = document.getElementById('badge-category').value;
                const points = parseInt(document.getElementById('badge-category-points').value);
                if(!points || points < 1) return alert('Especifica los puntos');
                badge.categoryRequirement = { category, points };
            } else if(reqType === 'multiple') {
                const requirements = {};
                document.querySelectorAll('.badge-multi-score').forEach(input => {
                    const val = parseInt(input.value) || 0;
                    if(val > 0) requirements[input.dataset.cat] = val;
                });
                if(Object.keys(requirements).length === 0) return alert('Especifica al menos un requisito');
                badge.multipleRequirements = requirements;
            }
            
            db.badges.push(badge);
            save();
            
            document.getElementById('badge-name').value = '';
            document.getElementById('badge-emoji').value = '';
            document.getElementById('badge-total-points').value = '';
            document.getElementById('badge-category-points').value = '';
            document.querySelectorAll('.badge-multi-score').forEach(i => i.value = 0);
            
            renderBadgesList();
        }

        function renderBadgesList() {
            const container = document.getElementById('badges-list');
            container.innerHTML = '';
            
            if(db.badges.length === 0) {
                container.innerHTML = '<p style="color:#999; font-size:12px;">No hay insignias creadas</p>';
                return;
            }
            
            db.badges.forEach(badge => {
                let reqText = '';
                if(badge.requirementType === 'total') {
                    reqText = `Total: ${badge.totalPoints} pts`;
                } else if(badge.requirementType === 'category') {
                    reqText = `${badge.categoryRequirement.category}: ${badge.categoryRequirement.points} pts`;
                } else if(badge.requirementType === 'multiple') {
                    const reqs = Object.entries(badge.multipleRequirements).map(([cat, pts]) => `${cat}: ${pts}`).join(', ');
                    reqText = reqs;
                }
                
                container.innerHTML += `
                    <div class="badge-config-item">
                        <div class="badge-emoji-display">${badge.emoji}</div>
                        <div style="flex: 1;">
                            <strong>${badge.name}</strong><br>
                            <small>${reqText}</small>
                        </div>
                        <button class="small" style="background: var(--info); width: auto; margin-right: 5px;" onclick="openEditBadgeModal(${badge.id})">Editar</button>
                        <button class="danger small" onclick="deleteBadge(${badge.id})">Eliminar</button>
                    </div>
                `;
            });
        }

        function openEditBadgeModal(badgeId) {
            currentEditBadgeId = badgeId;
            const badge = db.badges.find(b => b.id === badgeId);
            if(!badge) return;
            
            document.getElementById('edit-badge-name').value = badge.name;
            document.getElementById('edit-badge-emoji').value = badge.emoji;
            document.getElementById('edit-badge-req-type').value = badge.requirementType;
            
            const catSelect = document.getElementById('edit-badge-category');
            catSelect.innerHTML = '';
            db.categories.forEach(cat => {
                catSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            
            const multiScores = document.getElementById('edit-badge-multiple-scores');
            multiScores.innerHTML = '';
            db.categories.forEach(cat => {
                const val = badge.multipleRequirements ? (badge.multipleRequirements[cat] || 0) : 0;
                multiScores.innerHTML += `<label>${cat} <input type="number" class="edit-badge-multi-score" data-cat="${cat}" value="${val}" min="0"></label>`;
            });
            
            if(badge.requirementType === 'total') {
                document.getElementById('edit-badge-total-points').value = badge.totalPoints || 0;
            } else if(badge.requirementType === 'category') {
                document.getElementById('edit-badge-category').value = badge.categoryRequirement.category;
                document.getElementById('edit-badge-category-points').value = badge.categoryRequirement.points;
            }
            
            toggleEditBadgeRequirements();
            document.getElementById('edit-badge-modal').classList.add('active');
        }

        function closeEditBadgeModal() {
            document.getElementById('edit-badge-modal').classList.remove('active');
            currentEditBadgeId = null;
        }

        function saveEditedBadge() {
            const badge = db.badges.find(b => b.id === currentEditBadgeId);
            if(!badge) return;
            
            badge.name = document.getElementById('edit-badge-name').value.trim();
            badge.emoji = document.getElementById('edit-badge-emoji').value.trim();
            badge.requirementType = document.getElementById('edit-badge-req-type').value;
            
            if(!badge.name || !badge.emoji) return alert('Completa nombre y emoji');
            
            if(badge.requirementType === 'total') {
                badge.totalPoints = parseInt(document.getElementById('edit-badge-total-points').value);
                delete badge.categoryRequirement;
                delete badge.multipleRequirements;
            } else if(badge.requirementType === 'category') {
                badge.categoryRequirement = {
                    category: document.getElementById('edit-badge-category').value,
                    points: parseInt(document.getElementById('edit-badge-category-points').value)
                };
                delete badge.totalPoints;
                delete badge.multipleRequirements;
            } else if(badge.requirementType === 'multiple') {
                const requirements = {};
                document.querySelectorAll('.edit-badge-multi-score').forEach(input => {
                    const val = parseInt(input.value) || 0;
                    if(val > 0) requirements[input.dataset.cat] = val;
                });
                badge.multipleRequirements = requirements;
                delete badge.totalPoints;
                delete badge.categoryRequirement;
            }
            
            save();
            closeEditBadgeModal();
            renderBadgesList();
        }

        function deleteBadge(badgeId) {
            if(!confirm('¬øEliminar esta insignia?')) return;
            db.badges = db.badges.filter(b => b.id !== badgeId);
            save();
            renderBadgesList();
        }
        function renderGlobalTasks() {
            const container = document.getElementById('global-tasks-list');
            container.innerHTML = '';
            
            const groups = {};
            db.globalTasks.forEach(gt => {
                if(!groups[gt.groupId]) groups[gt.groupId] = [];
                groups[gt.groupId].push(gt);
            });

            if(Object.keys(groups).length === 0) {
                container.innerHTML = '<p style="color:#999; font-size:12px;">No hay tareas globales creadas</p>';
                return;
            }

            Object.keys(groups).forEach(groupId => {
                const tasks = groups[groupId];
                const firstTask = tasks[0];
                const assignedUsers = db.users.filter(u => tasks.some(t => t.userId === u.id)).map(u => u.name).join(', ');
                
                const dayOrder = [1, 2, 3, 4, 5, 6, 0];
                const daysText = firstTask.isRepeat ? 
                    dayOrder
                        .filter(d => firstTask.repeatDays.includes(d))
                        .map(d => dayNamesShort[d])
                        .join(', ') 
                    : '';
                
                container.innerHTML += `
                    <div class="card admin-task-card" style="position: relative; padding-right: 70px;">
                        <strong>${firstTask.baseTitle || firstTask.title}</strong><br>
                        <small>üìÖ ${firstTask.date || 'Sin fecha'}</small><br>
                        <small>üë• ${assignedUsers}</small><br>
                        ${firstTask.isRepeat ? '<small>üîÑ Repetitiva (' + daysText + ')</small>' : ''}
                        <button class="edit-task-btn" onclick="openEditTaskModal('${groupId}')">‚úèÔ∏è</button>
                    </div>
                `;
            });
        }

        function createUser() {
            const name = document.getElementById('new-user-name').value.trim();
            if(!name) return alert('Escribe un nombre');
            if(db.users.some(u => u.name === name)) return alert('Ya existe un usuario con ese nombre');
            
            const newUser = {
                id: Date.now(),
                name: name,
                tasks: [],
                customScores: {}
            };
            
            db.categories.forEach(cat => {
                newUser.customScores[cat] = 0;
            });
            
            db.users.push(newUser);
            save();
            document.getElementById('new-user-name').value = '';
            renderUsersTab();
            renderHome();
        }

        function updateUserName(id, name) {
            const u = db.users.find(u => u.id === id);
            if(u && name.trim()) {
                u.name = name.trim();
                save();
            }
        }

        function deleteUser(id) {
            if(!confirm('¬øBorrar usuario? Se eliminar√°n todas sus tareas.')) return;
            
            db.globalTasks = db.globalTasks.filter(gt => gt.userId !== id);
            db.users = db.users.filter(u => u.id !== id);
            save();
            renderUsersTab();
            renderHome();
        }

        function loadUserScores() {
            const userId = parseInt(document.getElementById('edit-scores-user').value);
            if(!userId) {
                document.getElementById('user-scores-editor').style.display = 'none';
                return;
            }
            
            const user = db.users.find(u => u.id === userId);
            if(!user) return;
            
            if(!user.customScores) {
                user.customScores = {};
                db.categories.forEach(cat => {
                    user.customScores[cat] = 0;
                });
            }
            
            let taskScores = {};
            db.categories.forEach(c => taskScores[c] = 0);
            user.tasks.forEach(t => {
                if(t.status === 'Terminada') {
                    for(let cat in t.scores) {
                        if(!taskScores[cat]) taskScores[cat] = 0;
                        taskScores[cat] += t.scores[cat];
                    }
                }
            });
            
            const editor = document.getElementById('user-scores-editor');
            editor.style.display = 'block';
            editor.innerHTML = '<p style="font-size: 12px; color: #666; margin-bottom: 10px;">Ajusta manualmente los puntos acumulados:</p>';
            
            db.categories.forEach(cat => {
                const totalFromTasks = taskScores[cat] || 0;
                const customValue = user.customScores[cat] || 0;
                const total = totalFromTasks + customValue;
                
                editor.innerHTML += `
                    <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                        <strong>${cat}</strong><br>
                        <small style="color: #666;">De tareas: ${totalFromTasks} pts</small><br>
                        <label style="font-size: 12px;">Ajuste manual:</label>
                        <input type="number" class="user-score-input" data-cat="${cat}" value="${customValue}" onchange="updateUserScore(${userId}, '${cat}', this.value)" style="margin-top: 5px;">
                        <small style="color: var(--success); font-weight: bold;">Total: ${total} pts</small>
                    </div>
                `;
            });
        }

        function updateUserScore(userId, category, value) {
            const user = db.users.find(u => u.id === userId);
            if(!user) return;
            
            if(!user.customScores) user.customScores = {};
            user.customScores[category] = parseInt(value) || 0;
            
            save();
            loadUserScores();
        }

        function toggleRepeat() {
            document.getElementById('repeat-options').style.display = 
                document.getElementById('gt-repeat').checked ? 'block' : 'none';
        }

        function toggleEditRepeat() {
            document.getElementById('edit-repeat-options').style.display = 
                document.getElementById('edit-task-repeat').checked ? 'block' : 'none';
        }

        function login(id) {
            currentUser = db.users.find(u => u.id === id);
            document.getElementById('screen-home').classList.remove('active');
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('user-title').innerText = `Tareas de ${currentUser.name}`;
            showView('view-tasks');
        }

        function logout() {
            document.getElementById('main-app').style.display = 'none';
            currentUser = null;
            navTo('screen-home');
        }

        function showView(viewId) {
            document.querySelectorAll('#main-app .screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(viewId).classList.add('active');
            
            const titles = {
                'view-tasks': 'Tareas de ' + currentUser.name,
                'view-calendar': 'Calendario de ' + currentUser.name,
                'view-scores': 'Puntuaci√≥n de ' + currentUser.name,
                'view-badges': 'Insignias de ' + currentUser.name
            };
            document.getElementById('user-title').innerText = titles[viewId] || currentUser.name;
            
            const btnIndex = ['view-tasks', 'view-calendar', 'view-scores', 'view-badges'].indexOf(viewId);
            if(btnIndex >= 0) {
                document.querySelectorAll('.nav-btn')[btnIndex].classList.add('active');
            }

            if(viewId === 'view-tasks') renderTasks();
            if(viewId === 'view-calendar') renderCalendar();
            if(viewId === 'view-scores') renderScores();
            if(viewId === 'view-badges') renderBadges();
        }

        function saveGlobalTask() {
            const title = document.getElementById('gt-title').value.trim();
            const startDate = document.getElementById('gt-date').value;
            const isRepeat = document.getElementById('gt-repeat').checked;
            const assignedUsers = Array.from(document.querySelectorAll('.assign-user:checked')).map(el => parseInt(el.value));
            
            if(!title) return alert("Escribe un t√≠tulo para la tarea");
            if(assignedUsers.length === 0) return alert("Selecciona al menos un usuario");

            let scores = {};
            document.querySelectorAll('.sc-in').forEach(i => {
                scores[i.dataset.cat] = parseInt(i.value) || 0;
            });

            const groupId = 'group_' + Date.now();

            if(!isRepeat) {
                assignedUsers.forEach(userId => {
                    const user = db.users.find(u => u.id === userId);
                    const taskId = Date.now() + Math.random();
                    
                    const task = {
                        id: taskId,
                        groupId: groupId,
                        title: title,
                        baseTitle: title,
                        date: startDate,
                        status: 'En espera',
                        scores: scores,
                        isRepeat: false,
                        userId: userId
                    };
                    
                    user.tasks.push(task);
                    db.globalTasks.push(task);
                });
            } else {
                const selectedDays = Array.from(document.querySelectorAll('.day-opt:checked')).map(el => parseInt(el.value));
                if(selectedDays.length === 0) return alert("Selecciona al menos un d√≠a de repetici√≥n");
                
                assignedUsers.forEach(userId => {
                    const user = db.users.find(u => u.id === userId);
                    createRepeatedTasks(user, title, startDate, selectedDays, scores, groupId, userId);
                });
            }

            save();
            alert("Tareas creadas correctamente");
            
            document.getElementById('gt-title').value = '';
            document.getElementById('gt-date').value = '';
            document.querySelectorAll('.sc-in').forEach(i => i.value = 0);
            
            renderTasksTab();
        }

        function createRepeatedTasks(user, title, startDateStr, days, scores, groupId, userId) {
            let current = startDateStr ? new Date(startDateStr + 'T00:00:00') : new Date();
            current.setHours(0, 0, 0, 0);
            
            let count = 0;
            let attempts = 0;
            
            while(count < 3 && attempts < 30) {
                if(days.includes(current.getDay())) {
                    const dateStr = current.toISOString().split('T')[0];
                    const taskId = Date.now() + Math.random() + count;
                    
                    const task = {
                        id: taskId,
                        groupId: groupId,
                        title: `${title}. ${dayNames[current.getDay()]}`,
                        baseTitle: title,
                        date: dateStr,
                        status: 'En espera',
                        scores: scores,
                        isRepeat: true,
                        repeatDays: days,
                        userId: userId
                    };
                    
                    user.tasks.push(task);
                    db.globalTasks.push(task);
                    count++;
                }
                current.setDate(current.getDate() + 1);
                attempts++;
            }
        }
        function openEditTaskModal(groupId) {
            currentEditTaskGroupId = groupId;
            const tasks = db.globalTasks.filter(t => t.groupId === groupId);
            if(tasks.length === 0) return;
            
            const firstTask = tasks[0];
            
            document.getElementById('edit-task-title').value = firstTask.baseTitle || firstTask.title;
            document.getElementById('edit-task-date').value = firstTask.date || '';
            document.getElementById('edit-task-repeat').checked = firstTask.isRepeat;
            
            const editUserAssign = document.getElementById('edit-task-user-assign');
            editUserAssign.innerHTML = '';
            const currentUserIds = [...new Set(tasks.map(t => t.userId))];
            db.users.forEach(u => {
                const checked = currentUserIds.includes(u.id) ? 'checked' : '';
                editUserAssign.innerHTML += `<label><input type="checkbox" class="edit-assign-user" value="${u.id}" ${checked}> ${u.name}</label>`;
            });
            
            if(firstTask.isRepeat) {
                document.getElementById('edit-repeat-options').style.display = 'block';
                document.querySelectorAll('.edit-day-opt').forEach(cb => {
                    cb.checked = firstTask.repeatDays.includes(parseInt(cb.value));
                });
            } else {
                document.getElementById('edit-repeat-options').style.display = 'none';
            }
            
            const scoresDiv = document.getElementById('edit-task-scores');
            scoresDiv.innerHTML = '';
            db.categories.forEach(cat => {
                const val = firstTask.scores[cat] || 0;
                scoresDiv.innerHTML += `<label>${cat} <input type="number" class="edit-sc-in" data-cat="${cat}" value="${val}" min="0"></label>`;
            });
            
            document.getElementById('edit-task-modal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-task-modal').classList.remove('active');
            currentEditTaskGroupId = null;
        }

        function saveEditedTask() {
            if(!currentEditTaskGroupId) return;
            
            const title = document.getElementById('edit-task-title').value.trim();
            const date = document.getElementById('edit-task-date').value;
            const isRepeat = document.getElementById('edit-task-repeat').checked;
            const newUserIds = Array.from(document.querySelectorAll('.edit-assign-user:checked')).map(el => parseInt(el.value));
            
            if(!title) return alert("El t√≠tulo no puede estar vac√≠o");
            if(newUserIds.length === 0) return alert("Selecciona al menos un usuario");
            
            let scores = {};
            document.querySelectorAll('.edit-sc-in').forEach(i => {
                scores[i.dataset.cat] = parseInt(i.value) || 0;
            });
            
            const oldTasks = db.globalTasks.filter(t => t.groupId === currentEditTaskGroupId);
            const oldUserIds = [...new Set(oldTasks.map(t => t.userId))];
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            oldUserIds.forEach(userId => {
                if(!newUserIds.includes(userId)) {
                    const user = db.users.find(u => u.id === userId);
                    if(user) {
                        user.tasks = user.tasks.filter(t => 
                            t.groupId !== currentEditTaskGroupId || t.date < todayStr
                        );
                    }
                    db.globalTasks = db.globalTasks.filter(t => 
                        t.groupId !== currentEditTaskGroupId || t.userId !== userId || t.date < todayStr
                    );
                }
            });
            
            oldUserIds.filter(id => newUserIds.includes(id)).forEach(userId => {
                const user = db.users.find(u => u.id === userId);
                if(user) {
                    user.tasks = user.tasks.filter(t => 
                        t.groupId !== currentEditTaskGroupId || t.date < todayStr
                    );
                }
                db.globalTasks = db.globalTasks.filter(t => 
                    t.groupId !== currentEditTaskGroupId || t.userId !== userId || t.date < todayStr
                );
            });
            
            if(!isRepeat) {
                newUserIds.forEach(userId => {
                    const user = db.users.find(u => u.id === userId);
                    const taskId = Date.now() + Math.random();
                    
                    const task = {
                        id: taskId,
                        groupId: currentEditTaskGroupId,
                        title: title,
                        baseTitle: title,
                        date: date,
                        status: 'En espera',
                        scores: scores,
                        isRepeat: false,
                        userId: userId
                    };
                    
                    user.tasks.push(task);
                    db.globalTasks.push(task);
                });
            } else {
                const selectedDays = Array.from(document.querySelectorAll('.edit-day-opt:checked')).map(el => parseInt(el.value));
                if(selectedDays.length === 0) return alert("Selecciona al menos un d√≠a");
                
                newUserIds.forEach(userId => {
                    const user = db.users.find(u => u.id === userId);
                    createRepeatedTasks(user, title, date || todayStr, selectedDays, scores, currentEditTaskGroupId, userId);
                });
            }
            
            save();
            alert("Tarea actualizada");
            closeEditModal();
            renderTasksTab();
        }

        function renderTasks() {
            const container = document.getElementById('tasks-container');
            container.innerHTML = '';
            
            const activeTasks = currentUser.tasks.filter(t => 
                t.status === 'En espera' || t.status === 'En proceso'
            );
            
            if(activeTasks.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; margin-top:40px;">No tienes tareas pendientes üéâ</p>';
                return;
            }
            
            activeTasks.forEach(t => {
                let statusClass = 'espera';
                if(t.status === 'En proceso') statusClass = 'proceso';
                
                let scoresHtml = '<div class="task-scores">';
                for(let cat in t.scores) {
                    if(t.scores[cat] > 0) {
                        scoresHtml += `<span>${cat}: +${t.scores[cat]}</span>`;
                    }
                }
                scoresHtml += '</div>';
                
                container.innerHTML += `
                    <div class="card task-card st-${statusClass}" onclick="openStatusModal(${t.id})">
                        <span class="status-indicator status-${statusClass}">${t.status}</span>
                        <h4 style="margin: 5px 0;">${t.title}</h4>
                        <small>üìÖ ${t.date || 'Sin fecha'}</small>
                        ${t.isRepeat ? '<br><small style="color: var(--primary);">üîÑ Repetitiva</small>' : ''}
                        ${scoresHtml}
                    </div>
                `;
            });
        }

        function openStatusModal(taskId) {
            currentTaskId = taskId;
            const task = currentUser.tasks.find(t => t.id === taskId);
            if(!task) return;
            
            document.getElementById('modal-task-title').innerText = task.title;
            document.getElementById('status-modal').classList.add('active');
        }

        function closeStatusModal() {
            document.getElementById('status-modal').classList.remove('active');
            currentTaskId = null;
        }

        function changeTaskStatus(newStatus) {
            if(!currentTaskId) return;
            
            const task = currentUser.tasks.find(t => t.id === currentTaskId);
            if(!task) return;
            
            task.status = newStatus;
            
            if((newStatus === 'Terminada' || newStatus === 'Perdida') && task.isRepeat && task.repeatDays) {
                generateNextRepeatingTask(task);
            }
            
            save();
            closeStatusModal();
            renderTasks();
            renderCalendar();
            renderScores();
            renderBadges();
        }

        function generateNextRepeatingTask(completedTask) {
            const futureTasks = currentUser.tasks.filter(t => 
                t.groupId === completedTask.groupId && 
                (t.status === 'En espera' || t.status === 'En proceso') &&
                t.id !== completedTask.id
            );
            
            if(futureTasks.length >= 3) return;
            
            const taskDate = new Date(completedTask.date + 'T00:00:00');
            let nextDate = new Date(taskDate);
            nextDate.setDate(nextDate.getDate() + 1);
            
            let found = false;
            let attempts = 0;
            
            while(!found && attempts < 30) {
                if(completedTask.repeatDays.includes(nextDate.getDay())) {
                    const nextDateStr = nextDate.toISOString().split('T')[0];
                    
                    const exists = currentUser.tasks.some(t => 
                        t.groupId === completedTask.groupId && 
                        t.date === nextDateStr
                    );
                    
                    if(!exists) {
                        const newTaskId = Date.now() + Math.random();
                        const newTask = {
                            id: newTaskId,
                            groupId: completedTask.groupId,
                            title: `${completedTask.baseTitle}. ${dayNames[nextDate.getDay()]}`,
                            baseTitle: completedTask.baseTitle,
                            date: nextDateStr,
                            status: 'En espera',
                            scores: completedTask.scores,
                            isRepeat: true,
                            repeatDays: completedTask.repeatDays,
                            userId: currentUser.id
                        };
                        
                        currentUser.tasks.push(newTask);
                        
                        const userIndex = db.users.findIndex(u => u.id === currentUser.id);
                        db.users[userIndex] = currentUser;
                        
                        found = true;
                    }
                }
                nextDate.setDate(nextDate.getDate() + 1);
                attempts++;
            }
        }

        function renderCalendar() {
            const container = document.getElementById('calendar-container');
            container.innerHTML = '';
            
            const datedTasks = currentUser.tasks
                .filter(t => t.date)
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if(datedTasks.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; margin-top:40px;">No hay tareas con fecha asignada</p>';
                return;
            }
            
            let lastDate = '';
            datedTasks.forEach(t => {
                if(t.date !== lastDate) {
                    const dateObj = new Date(t.date + 'T00:00:00');
                    const dayName = dayNames[dateObj.getDay()];
                    container.innerHTML += `<h3 style="color: var(--primary); margin-top: 20px; border-bottom: 2px solid var(--primary); padding-bottom: 5px;">${t.date} - ${dayName}</h3>`;
                    lastDate = t.date;
                }
                
                let statusClass = 'espera';
                if(t.status === 'En proceso') statusClass = 'proceso';
                if(t.status === 'Terminada') statusClass = 'terminada';
                if(t.status === 'Perdida') statusClass = 'perdida';
                
                container.innerHTML += `
                    <div class="card st-${statusClass}" style="border-left: 4px solid;">
                        <span class="status-indicator status-${statusClass}">${t.status}</span>
                        <strong>${t.title}</strong>
                    </div>
                `;
            });
        }

        function renderScores() {
            const container = document.getElementById('scores-container');
            container.innerHTML = '';
            
            let totals = {};
            db.categories.forEach(c => totals[c] = 0);

            currentUser.tasks.forEach(t => {
                if(t.status === 'Terminada') {
                    for(let cat in t.scores) {
                        if(!totals[cat]) totals[cat] = 0;
                        totals[cat] += t.scores[cat];
                    }
                }
            });

            if(currentUser.customScores) {
                for(let cat in currentUser.customScores) {
                    if(!totals[cat]) totals[cat] = 0;
                    totals[cat] += currentUser.customScores[cat];
                }
            }

            for(let cat in totals) {
                container.innerHTML += `
                    <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
                        <strong style="font-size: 18px;">${cat}</strong> 
                        <span style="font-size: 24px; color: var(--success); font-weight: bold;">${totals[cat]}</span>
                    </div>
                `;
            }
        }

        function renderBadges() {
            const container = document.getElementById('badges-container');
            container.innerHTML = '';
            
            if(db.badges.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; margin-top:40px;">No hay insignias configuradas</p>';
                return;
            }

            let userScores = {};
            db.categories.forEach(c => userScores[c] = 0);

            currentUser.tasks.forEach(t => {
                if(t.status === 'Terminada') {
                    for(let cat in t.scores) {
                        if(!userScores[cat]) userScores[cat] = 0;
                        userScores[cat] += t.scores[cat];
                    }
                }
            });

            if(currentUser.customScores) {
                for(let cat in currentUser.customScores) {
                    if(!userScores[cat]) userScores[cat] = 0;
                    userScores[cat] += currentUser.customScores[cat];
                }
            }

            const totalPoints = Object.values(userScores).reduce((a, b) => a + b, 0);

            container.innerHTML = '<div class="badge-grid"></div>';
            const grid = container.querySelector('.badge-grid');

            db.badges.forEach(badge => {
                let unlocked = false;
                let progressText = '';
                
                if(badge.requirementType === 'total') {
                    unlocked = totalPoints >= badge.totalPoints;
                    progressText = unlocked ? 'üéâ Desbloqueada' : `${totalPoints}/${badge.totalPoints} pts`;
                } else if(badge.requirementType === 'category') {
                    const userPoints = userScores[badge.categoryRequirement.category] || 0;
                    unlocked = userPoints >= badge.categoryRequirement.points;
                    progressText = unlocked ? 'üéâ Desbloqueada' : `${userPoints}/${badge.categoryRequirement.points} pts en ${badge.categoryRequirement.category}`;
                } else if(badge.requirementType === 'multiple') {
                    unlocked = Object.entries(badge.multipleRequirements).every(([cat, req]) => {
                        return (userScores[cat] || 0) >= req;
                    });
                    if(!unlocked) {
                        const progress = Object.entries(badge.multipleRequirements).map(([cat, req]) => {
                            const current = userScores[cat] || 0;
                            return `${cat}: ${current}/${req}`;
                        }).join(', ');
                        progressText = progress;
                    } else {
                        progressText = 'üéâ Desbloqueada';
                    }
                }
                
                grid.innerHTML += `
                    <div class="badge-item">
                        <div class="badge-image ${unlocked ? 'unlocked' : 'locked'}">
                            ${badge.emoji}
                        </div>
                        <div class="badge-name">${badge.name}</div>
                        <div class="badge-progress">${progressText}</div>
                    </div>
                `;
            });
        }

        function exportBackup() {
            const dataStr = JSON.stringify(db, null, 2);
            
            const now = new Date();
            const timestamp = now.toISOString().split('T')[0] + '_' + 
                              now.getHours().toString().padStart(2, '0') + 
                              now.getMinutes().toString().padStart(2, '0') +
                              now.getSeconds().toString().padStart(2, '0');
            const fileName = `gestor_elite_backup_${timestamp}.json`;
            
            if (navigator.share && navigator.canShare) {
                const blob = new Blob([dataStr], { type: 'application/json' });
                const file = new File([blob], fileName, { type: 'application/json' });
                
                if (navigator.canShare({ files: [file] })) {
                    navigator.share({
                        title: 'Backup Gestor Elite',
                        text: 'Copia de seguridad',
                        files: [file]
                    })
                    .catch(() => {
                        fallbackExport(dataStr, fileName);
                    });
                    return;
                }
            }
            
            fallbackExport(dataStr, fileName);
        }

        function fallbackExport(dataStr, fileName) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;';
            
            modal.innerHTML = `
                <div style="background:white;padding:20px;border-radius:12px;max-width:95%;width:400px;max-height:80vh;overflow:auto;box-sizing:border-box;">
                    <h3 style="margin-top:0;">Backup Generado</h3>
                    <p style="font-size:14px;color:#666;">Copia este texto y gu√°rdalo:</p>
                    <textarea id="backup-text" readonly style="width:100%;height:300px;font-family:monospace;font-size:11px;padding:10px;border:1px solid #ddd;border-radius:5px;margin:10px 0;box-sizing:border-box;">${dataStr}</textarea>
                    <button onclick="copyBackupText()" style="width:100%;background:#4a90e2;color:white;border:none;padding:12px;border-radius:8px;font-weight:bold;margin-bottom:10px;">üìã Copiar</button>
                    <button onclick="downloadBackup('${fileName}')" style="width:100%;background:#2ecc71;color:white;border:none;padding:12px;border-radius:8px;font-weight:bold;margin-bottom:10px;">üíæ Descargar</button>
                    <button onclick="this.parentElement.parentElement.remove()" style="width:100%;background:#95a5a6;color:white;border:none;padding:12px;border-radius:8px;font-weight:bold;">Cerrar</button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function downloadBackup(fileName) {
            const dataStr = document.getElementById('backup-text').value;
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
        }

        function copyBackupText() {
            const textarea = document.getElementById('backup-text');
            textarea.select();
            textarea.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                alert('‚úÖ Backup copiado!');
            } catch (err) {
                alert('‚ùå No se pudo copiar.');
            }
        }

        function showPasteBackup() {
            document.getElementById('paste-backup-modal').classList.add('active');
            document.getElementById('paste-backup-text').value = '';
            document.getElementById('paste-backup-text').focus();
        }

        function closePasteBackupModal() {
            document.getElementById('paste-backup-modal').classList.remove('active');
            document.getElementById('paste-backup-text').value = '';
        }

        function processPastedBackup() {
            const pastedText = document.getElementById('paste-backup-text').value.trim();
            
            if(!pastedText) return alert('‚ùå No has pegado ning√∫n contenido.');
            
            if(!confirm('‚ö†Ô∏è ¬øEst√°s seguro?\n\nSe reemplazar√°n TODOS los datos actuales.')) return;
            
            try {
                const importedData = JSON.parse(pastedText);
                
                if(!importedData.users || !Array.isArray(importedData.users)) {
                    throw new Error('Formato inv√°lido');
                }
                
                if(!importedData.categories) importedData.categories = ['Responsabilidad', 'Amabilidad', 'Respeto'];
                if(!importedData.globalTasks) importedData.globalTasks = [];
                if(!importedData.badges) importedData.badges = [];
                if(!importedData.version) importedData.version = DB_VERSION;
                
                db = migrateDatabase(importedData);
                save();
                
                closePasteBackupModal();
                alert('‚úÖ Backup restaurado!\n\n- ' + db.users.length + ' usuarios\n- ' + db.categories.length + ' categor√≠as\n- ' + db.badges.length + ' insignias');
                
                renderSettings();
                renderHome();
                
            } catch(error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        function importBackup(event) {
            const file = event.target.files[0];
            if(!file) return;
            
            if(!confirm('‚ö†Ô∏è ¬øEst√°s seguro?\n\nSe reemplazar√°n TODOS los datos.')) {
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if(!importedData.users || !Array.isArray(importedData.users)) {
                        throw new Error('Formato inv√°lido');
                    }
                    
                    if(!importedData.categories) importedData.categories = ['Responsabilidad', 'Amabilidad', 'Respeto'];
                    if(!importedData.globalTasks) importedData.globalTasks = [];
                    if(!importedData.badges) importedData.badges = [];
                    if(!importedData.version) importedData.version = DB_VERSION;
                    
                    db = migrateDatabase(importedData);
                    save();
                    
                    alert('‚úÖ Backup restaurado!');
                    renderSettings();
                    renderHome();
                    
                } catch(error) {
                    alert('‚ùå Error: ' + error.message);
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        renderHome();
    </script>
</body>
</html>