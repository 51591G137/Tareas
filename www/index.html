<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Academia de H√©roes</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>

    <!-- Pantalla de inicio -->
    <div id="screen-home" class="screen active">
        <h2 style="text-align: center; margin-top: 40px;">ü¶∏ Academia de H√©roes</h2>
        <p style="text-align: center; color: #666;">Selecciona tu h√©roe</p>
        <div id="users-list-home"></div>
        
        <button class="settings-btn" onclick="navTo('screen-settings')">‚öôÔ∏è</button>
    </div>

    <!-- Pantalla de configuraci√≥n -->
    <div id="screen-settings" class="screen">
        <button class="secondary small" onclick="navTo('screen-home')" style="margin-bottom: 15px;">‚¨Ö Volver</button>
        <h3>Centro de Control</h3>
        
        <div class="config-tabs">
            <button class="config-tab active" onclick="showConfigTab('tab-heroes')">ü¶∏ H√©roes</button>
            <button class="config-tab" onclick="showConfigTab('tab-missions')">üéØ Misiones</button>
            <button class="config-tab" onclick="showConfigTab('tab-powers')">‚ö° Poderes</button>
            <button class="config-tab" onclick="showConfigTab('tab-badges')">üèÜ Logros</button>
            <button class="config-tab" onclick="showConfigTab('tab-backup')">üíæ Backup</button>
        </div>

        <!-- TAB: H√©roes -->
        <div id="tab-heroes" class="config-tab-content">
            <div class="card">
                <h4>Gestionar H√©roes</h4>
                <input type="text" id="new-user-name" placeholder="Nombre del nuevo h√©roe">
                <button onclick="createUser()">+ A√±adir H√©roe</button>
                <div id="users-manage-list" style="margin-top:15px;"></div>
            </div>

            <div class="card">
                <h4>Editar Puntuaciones de H√©roes</h4>
                <p style="font-size: 12px; color: #666;">Modifica directamente los puntos de cada h√©roe</p>
                <select id="edit-scores-user" onchange="loadUserScores()">
                    <option value="">Selecciona un h√©roe</option>
                </select>
                <div id="user-scores-editor" style="display:none; margin-top:10px;"></div>
            </div>
        </div>

        <!-- TAB: Misiones -->
        <div id="tab-missions" class="config-tab-content" style="display:none;">
            <div class="card expandable-section">
                <div class="section-header" onclick="toggleSection('mission-types-section')">
                    <h4 style="display: inline-block; margin: 0;">Tipos de Misiones</h4>
                    <span id="mission-types-toggle" style="float: right; font-size: 14px;">‚ñº</span>
                </div>
                <div id="mission-types-section" class="section-content expanded">
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">Gestiona los tipos de misiones disponibles</p>
                    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                        <input type="text" id="new-mission-type-icon" placeholder="Emoji" maxlength="2" style="width: 60px;">
                        <input type="text" id="new-mission-type-name" placeholder="Nombre del tipo" style="flex: 1;">
                        <button onclick="addMissionType()" style="width: auto;">+ A√±adir</button>
                    </div>
                    <div id="mission-types-list"></div>
                </div>
            </div>

            <div class="card expandable-section">
                <div class="section-header" onclick="toggleSection('create-mission-section')">
                    <h4 style="display: inline-block; margin: 0;">Crear Misi√≥n Global</h4>
                    <span id="create-mission-toggle" style="float: right; font-size: 14px;">‚ñº</span>
                </div>
                <div id="create-mission-section" class="section-content expanded">
                    <input type="text" id="gm-title" placeholder="T√≠tulo de la misi√≥n">
                    <textarea id="gm-description" placeholder="Descripci√≥n de la misi√≥n (opcional)" style="width: 100%; min-height: 60px; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit;"></textarea>
                    
                    <label style="font-size: 12px; color: #666; margin-top: 10px;">Tipo de misi√≥n:</label>
                    <select id="gm-type"></select>
                    
                    <label style="font-size: 12px; color: #666; margin-top: 10px;">Fecha de inicio:</label>
                    <input type="date" id="gm-start-date">
                    
                    <label style="font-size: 12px; color: #666; margin-top: 5px;">Fecha de fin:</label>
                    <input type="date" id="gm-end-date">
                    
                    <div style="margin: 10px 0;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="gm-time-range" onchange="toggleTimeRange()" style="width: auto; margin: 0;"> 
                            ¬øTiene horario espec√≠fico?
                        </label>
                    </div>

                    <div id="time-range-options" style="display:none;">
                        <label style="font-size: 12px;">Hora de inicio:</label>
                        <input type="time" id="gm-time-start">
                        <label style="font-size: 12px;">Hora de fin:</label>
                        <input type="time" id="gm-time-end">
                    </div>
                    
                    <p style="margin: 10px 0 5px 0;"><strong>Asignar a:</strong></p>
                    <div id="gm-user-assign" class="user-checkbox-list"></div>

                    <div style="margin: 10px 0;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="gm-repeat" onchange="toggleRepeat()" style="width: auto; margin: 0;"> 
                            ¬øSe repite?
                        </label>
                    </div>

                    <div id="repeat-options" style="display:none;">
                        <p style="margin: 5px 0;"><strong>D√≠as de repetici√≥n:</strong></p>
                        <div class="days-selector">
                            <label class="day-check">L<input type="checkbox" class="day-opt" value="1"></label>
                            <label class="day-check">M<input type="checkbox" class="day-opt" value="2"></label>
                            <label class="day-check">X<input type="checkbox" class="day-opt" value="3"></label>
                            <label class="day-check">J<input type="checkbox" class="day-opt" value="4"></label>
                            <label class="day-check">V<input type="checkbox" class="day-opt" value="5"></label>
                            <label class="day-check">S<input type="checkbox" class="day-opt" value="6"></label>
                            <label class="day-check">D<input type="checkbox" class="day-opt" value="0"></label>
                        </div>
                    </div>

                    <h4 style="margin-top: 15px;">Recompensas (Puntos de Poder)</h4>
                    <div id="gm-scores"></div>
                    
                    <h4 style="margin-top: 15px;">Mensajes</h4>
                    <label style="font-size: 12px;">Mensaje al seleccionar:</label>
                    <input type="text" id="gm-select-msg" placeholder="¬°Excelente elecci√≥n, h√©roe! ü¶∏">
                    <label style="font-size: 12px;">Mensaje al completar:</label>
                    <input type="text" id="gm-complete-msg" placeholder="¬°Misi√≥n cumplida! Has ganado experiencia ‚ú®">
                    
                    <button onclick="saveGlobalMission()" style="margin-top:10px; background: var(--success);">Crear Misiones</button>
                </div>
            </div>

            <div class="card">
                <h4>Misiones Globales Creadas</h4>
                <div id="global-missions-list"></div>
            </div>
        </div>

        <!-- TAB: Poderes -->
        <div id="tab-powers" class="config-tab-content" style="display:none;">
            <div class="card">
                <h4>Gesti√≥n de Superpoderes y Poderes</h4>
                <p style="font-size: 12px; color: #666;">Los Superpoderes contienen Poderes espec√≠ficos que los h√©roes pueden desarrollar</p>
                <input type="text" id="new-superpower" placeholder="Nuevo Superpoder (ej: Responsabilidad)">
                <button onclick="addSuperpower()">+ A√±adir Superpoder</button>
                <div id="superpowers-list" style="margin-top: 15px;"></div>
            </div>
        </div>

        <!-- TAB: Logros -->
        <div id="tab-badges" class="config-tab-content" style="display:none;">
            <div class="card">
                <h4>Crear Logro</h4>
                <p style="font-size: 12px; color: #666;">Crea logros que se desbloquean al alcanzar puntos</p>
                
                <label style="font-size: 12px;">Nombre del logro:</label>
                <input type="text" id="badge-name" placeholder="Ej: Maestro del Orden">
                
                <label style="font-size: 12px;">Emoji/Icono:</label>
                <input type="text" id="badge-emoji" placeholder="Ej: üèÜ ‚≠ê üéñÔ∏è üëë" maxlength="2">
                
                <label style="font-size: 12px;">Tipo de requisito:</label>
                <select id="badge-req-type" onchange="toggleBadgeRequirements()">
                    <option value="total">Puntos totales (suma de todos los poderes)</option>
                    <option value="category">Puntos en superpoder espec√≠fico</option>
                    <option value="multiple">Puntos en m√∫ltiples superpoderes</option>
                </select>
                
                <div id="badge-total-req" style="margin-top: 10px;">
                    <label style="font-size: 12px;">Puntos totales necesarios:</label>
                    <input type="number" id="badge-total-points" placeholder="Ej: 10" min="1">
                </div>

                <div id="badge-category-req" style="display: none; margin-top: 10px;">
                    <label style="font-size: 12px;">Superpoder:</label>
                    <select id="badge-category"></select>
                    <label style="font-size: 12px;">Puntos necesarios:</label>
                    <input type="number" id="badge-category-points" placeholder="Ej: 100" min="1">
                </div>

                <div id="badge-multiple-req" style="display: none; margin-top: 10px;">
                    <p style="font-size: 12px;"><strong>Puntos necesarios por superpoder:</strong></p>
                    <div id="badge-multiple-scores"></div>
                </div>
                
                <button onclick="addBadge()" style="background: var(--success); margin-top: 10px;">+ A√±adir Logro</button>
            </div>

            <div class="card">
                <h4>Logros Creados</h4>
                <div id="badges-list"></div>
            </div>
        </div>

        <!-- TAB: Backup -->
        <div id="tab-backup" class="config-tab-content" style="display:none;">
            <div class="card">
                <h4>Copia de Seguridad</h4>
                <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                    Guarda todos tus datos (h√©roes, misiones, puntuaciones, logros).
                </p>
                <button onclick="exportBackup()" style="background: var(--success);">üì§ Compartir/Crear Backup</button>
                
                <h4 style="margin-top: 20px;">Restaurar Backup</h4>
                <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                    Elige c√≥mo quieres restaurar tus datos:
                </p>
                <button class="secondary" onclick="showPasteBackup()">üìã Pegar Backup</button>
                <button class="secondary" onclick="document.getElementById('import-file').click();" style="margin-top: 10px;">üìÅ Subir Archivo</button>
                <input type="file" id="import-file" accept=".json,.txt" style="display:none;" onchange="importBackup(event)">
                
                <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
                    <small style="color: #856404;">
                        <strong>‚ö†Ô∏è Importante:</strong> Al restaurar un backup, se reemplazar√°n todos los datos actuales.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Aplicaci√≥n principal -->
    <div id="main-app" style="display:none;">
        <div style="position: fixed; top: 0; left: 0; right: 0; background: #fff; padding: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 200; display: flex; justify-content: space-between; align-items: center;">
            <h2 id="user-title" style="margin: 0;">Misiones</h2>
            <button class="danger small" onclick="logout()">Salir</button>
        </div>

        <div style="padding-top: 70px;">
            <div id="view-missions" class="screen">
                <div id="missions-container"></div>
            </div>

            <div id="view-powers" class="screen">
                <div id="powers-container"></div>
            </div>

            <div id="view-achievements" class="screen">
                <div id="achievements-container"></div>
            </div>

            <div id="view-diary" class="screen">
                <div id="diary-container"></div>
            </div>
        </div>

        <nav class="nav-bottom">
            <button class="nav-btn" onclick="showView('view-missions')">üéØ<br><small>Misiones</small></button>
            <button class="nav-btn" onclick="showView('view-powers')">‚ö°<br><small>Poderes</small></button>
            <button class="nav-btn" onclick="showView('view-achievements')">üèÜ<br><small>Logros</small></button>
            <button class="nav-btn" onclick="showView('view-diary')">üìñ<br><small>Diario</small></button>
        </nav>
    </div>

    <!-- Modal de misi√≥n -->
    <div id="mission-modal" class="modal">
        <div class="modal-content">
            <h3 id="mission-modal-title">Misi√≥n</h3>
            <p id="mission-modal-description" style="color: #666; margin-bottom: 15px;"></p>
            
            <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                <p id="mission-modal-select-msg" style="margin: 0; font-style: italic; color: #1976d2;"></p>
            </div>
            
            <h4>Recompensas:</h4>
            <div id="mission-modal-rewards" style="margin-bottom: 15px;"></div>
            
            <div class="modal-buttons">
                <button onclick="startMission()" style="background: var(--info);">üöÄ Empezar Misi√≥n</button>
                <button onclick="completeMission()" style="background: var(--success);">‚úÖ Marcar como Completada</button>
                <button class="secondary" onclick="closeMissionModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de edici√≥n de misi√≥n -->
    <div id="edit-mission-modal" class="modal">
        <div class="modal-content">
            <h3>Editar Misi√≥n</h3>
            <input type="text" id="edit-mission-title" placeholder="T√≠tulo">
            <textarea id="edit-mission-description" placeholder="Descripci√≥n" style="width: 100%; min-height: 60px; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit;"></textarea>
            
            <label style="font-size: 12px;">Tipo:</label>
            <select id="edit-mission-type"></select>
            
            <label style="font-size: 12px;">Fecha inicio:</label>
            <input type="date" id="edit-mission-start-date">
            
            <label style="font-size: 12px;">Fecha fin:</label>
            <input type="date" id="edit-mission-end-date">
            
            <div style="margin: 10px 0;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="edit-mission-time-range" onchange="toggleEditTimeRange()" style="width: auto; margin: 0;"> 
                    ¬øTiene horario espec√≠fico?
                </label>
            </div>

            <div id="edit-time-range-options" style="display:none;">
                <label style="font-size: 12px;">Hora inicio:</label>
                <input type="time" id="edit-mission-time-start">
                <label style="font-size: 12px;">Hora fin:</label>
                <input type="time" id="edit-mission-time-end">
            </div>
            
            <p style="margin: 10px 0 5px 0;"><strong>Asignar a:</strong></p>
            <div id="edit-mission-user-assign" class="user-checkbox-list"></div>

            <div style="margin: 10px 0;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="edit-mission-repeat" onchange="toggleEditRepeat()" style="width: auto; margin: 0;"> 
                    ¬øSe repite?
                </label>
            </div>

            <div id="edit-repeat-options" style="display:none;">
                <p style="margin: 5px 0;"><strong>D√≠as de repetici√≥n:</strong></p>
                <div class="days-selector">
                    <label class="day-check">L<input type="checkbox" class="edit-day-opt" value="1"></label>
                    <label class="day-check">M<input type="checkbox" class="edit-day-opt" value="2"></label>
                    <label class="day-check">X<input type="checkbox" class="edit-day-opt" value="3"></label>
                    <label class="day-check">J<input type="checkbox" class="edit-day-opt" value="4"></label>
                    <label class="day-check">V<input type="checkbox" class="edit-day-opt" value="5"></label>
                    <label class="day-check">S<input type="checkbox" class="edit-day-opt" value="6"></label>
                    <label class="day-check">D<input type="checkbox" class="edit-day-opt" value="0"></label>
                </div>
            </div>

            <h4>Recompensas</h4>
            <div id="edit-mission-scores"></div>

            <h4>Mensajes</h4>
            <input type="text" id="edit-mission-select-msg" placeholder="Mensaje al seleccionar">
            <input type="text" id="edit-mission-complete-msg" placeholder="Mensaje al completar">

            <div class="modal-buttons">
                <button onclick="saveEditedMission()">Guardar</button>
                <button class="secondary" onclick="closeEditMissionModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de pegar backup -->
    <div id="paste-backup-modal" class="modal">
        <div class="modal-content">
            <h3>Pegar Backup</h3>
            <p style="font-size: 12px; color: #666;">Pega aqu√≠ el contenido del backup que copiaste:</p>
            <textarea id="paste-backup-text" placeholder="Pega aqu√≠ el backup..." style="width:100%;height:250px;font-family:monospace;font-size:11px;padding:10px;border:1px solid #ddd;border-radius:5px;margin:10px 0;box-sizing:border-box;"></textarea>
            <div class="modal-buttons">
                <button onclick="processPastedBackup()" style="background: var(--success);">‚úÖ Restaurar</button>
                <button class="secondary" onclick="closePasteBackupModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal editar logro -->
    <div id="edit-badge-modal" class="modal">
        <div class="modal-content">
            <h3>Editar Logro</h3>
            <input type="text" id="edit-badge-name" placeholder="Nombre">
            <input type="text" id="edit-badge-emoji" placeholder="Emoji" maxlength="2">
            
            <label style="font-size: 12px;">Tipo de requisito:</label>
            <select id="edit-badge-req-type" onchange="toggleEditBadgeRequirements()">
                <option value="total">Puntos totales</option>
                <option value="category">Superpoder espec√≠fico</option>
                <option value="multiple">M√∫ltiples superpoderes</option>
            </select>
            
            <div id="edit-badge-total-req" style="margin-top: 10px;">
                <input type="number" id="edit-badge-total-points" placeholder="Puntos totales" min="1">
            </div>

            <div id="edit-badge-category-req" style="display: none; margin-top: 10px;">
                <select id="edit-badge-category"></select>
                <input type="number" id="edit-badge-category-points" placeholder="Puntos" min="1">
            </div>

            <div id="edit-badge-multiple-req" style="display: none; margin-top: 10px;">
                <div id="edit-badge-multiple-scores"></div>
            </div>

            <div class="modal-buttons">
                <button onclick="saveEditedBadge()">Guardar</button>
                <button class="secondary" onclick="closeEditBadgeModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Scripts principales -->
    <script src="js/database.js"></script>
    <script src="js/views/views.js"></script>  
    <script src="js/navigation.js"></script>

    <!-- M√≥dulos de configuraci√≥n -->
    <script src="js/config/users.js"></script>
    <script src="js/config/superpowers.js"></script>
    <script src="js/config/missions.js"></script>
    <script src="js/config/badges.js"></script>
    <script src="js/config/backup.js"></script>

    <!-- Vistas de usuario -->
    <script src="js/views/missions-view.js"></script>
    <script src="js/views/powers-view.js"></script>
    <script src="js/views/achievements-view.js"></script>
    <script src="js/views/diary-view.js"></script>
    <script src="js/views/mission-modal.js"></script>
    
    <script>
        // Esperar a que el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar variables globales
            window.currentUser = null;
            window.dayNames = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];
            window.dayNamesShort = ["Dom", "Lun", "Mar", "Mi√©", "Jue", "Vie", "S√°b"];
            window.monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            
            // Asegurarse de que la base de datos est√© cargada
            if (typeof db === 'undefined') {
                console.error('La base de datos no se carg√≥ correctamente');
                window.db = loadDatabase();
                window.save = function() { 
                    db.version = 5;
                    localStorage.setItem('eliteDB', JSON.stringify(db)); 
                };
            }
            
            // Renderizar la pantalla de inicio
            if (typeof renderHome === 'function') {
                renderHome();
            } else {
                console.error('renderHome no est√° definida');
                document.getElementById('users-list-home').innerHTML = 
                    '<p style="color: red;">Error: la funci√≥n renderHome no est√° disponible.</p>';
            }
        });
    </script>
</body>
</html>